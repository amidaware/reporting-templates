{
  "base_template": {
    "name": "TRMM_Base v1.1",
    "html": "<html>\n\n<head>\n    <style>\n        /* —— PDF page settings —— */\n        @page {\n            margin: 0.5in;\n            size: letter portrait;\n        }\n\n        /* —— Color palette (theme) —— */\n        :root {\n            --header-bg: #2c3e50;\n            --header-text: #ffffff;\n            --border-color: #dddddd;\n            --table-header-bg: #f2f2f2;\n            --status-ready-bg: #eaf7ec;\n            --status-ready-badge: #28a745;\n            --status-not-ready-bg: #fbebee;\n            --status-not-ready-badge: #dc3545;\n            --status-unknown-bg: #fff9e6;\n            --status-unknown-badge: #ffc107;\n            --badge-already-bg: #17a2b8;\n        }\n\n        /* —— Typography & utilities (structure) —— */\n        body {\n            font-family: sans-serif;\n            color: #333;\n            font-size: 12px;\n        }\n\n        .section {\n            margin-top: 20px;\n        }\n\n        .text-danger {\n            color: #a94442;\n            font-weight: bold;\n        }\n\n        /* —— Header layout (structure) —— */\n        .report-header {\n            background-color: var(--header-bg);\n            color: var(--header-text);\n            padding: 20px;\n            border-radius: 8px;\n            display: flex;\n            align-items: center;\n        }\n\n        .header-logo {\n            width: 80px;\n            margin-right: 25px;\n            flex-shrink: 0;\n        }\n\n        .header-date {\n            margin-left: auto;\n            text-align: right;\n            white-space: nowrap;\n        }\n\n        .report-header h1 {\n            font-size: 24px;\n            margin: 0 0 5px;\n        }\n\n        .report-header h2 {\n            font-size: 16px;\n            margin: 0;\n            opacity: 0.9;\n        }\n\n        /* —— Standardized Table Styles (structure) —— */\n        .report-table {\n            border-collapse: collapse;\n            width: 100%;\n        }\n\n        .report-table th,\n        .report-table td {\n            border: 1px solid var(--border-color);\n            padding: 6px 8px;\n            text-align: left;\n            vertical-align: top;\n        }\n\n        .report-table thead th {\n            background-color: var(--table-header-bg);\n            font-weight: bold;\n            cursor: pointer;\n            user-select: none;\n        }\n\n        /* Header label + sort indicators */\n        .th-topline {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            gap: .4rem;\n        }\n\n        .th-label {\n            position: relative;\n            cursor: pointer;\n            user-select: none;\n        }\n\n        /* These are the specific rules that make the indicator visible */\n        th.sorted.asc .th-label::after {\n            content: \"▲\";\n            padding-left: .4rem;\n            color: #333;\n            font-size: .9em;\n        }\n\n        th.sorted.desc .th-label::after {\n            content: \"▼\";\n            padding-left: .4rem;\n            color: #333;\n            font-size: .9em;\n        }\n\n        .report-table thead th select {\n            width: 100%;\n            margin-top: 5px;\n            padding: 4px;\n            border-radius: 4px;\n            border: 1px solid #ccc;\n            font-weight: normal;\n            background: #fff;\n        }\n\n        /* —— Badge shape (structure) —— */\n        .status-badge {\n            display: inline-block;\n            padding: 4px 10px;\n            border-radius: 12px;\n            color: #fff;\n            font-weight: bold;\n            font-size: 11px;\n            text-align: center;\n            white-space: nowrap;\n        }\n\n        /* —— Stub classes for per‑report overrides —— */\n        .status-ready {}\n\n        .status-not-ready {}\n\n        .status-unknown {}\n\n        .badge-ready {}\n\n        .badge-not-ready {}\n\n        .badge-unknown {}\n\n        .badge-already {}\n    </style>\n</head>\n\n<body>\n    {% block content %}{% endblock %}\n</body>\n\n</html>"
  },
  "template": {
    "name": "Alerts - Interactive Dashboard (html) v1.6",
    "template_css": "",
    "template_md": "{% block content %}\r\n\r\n<!-- Load Chart.js (Optional) -->\r\n<script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\r\n\r\n<title>Alert Analysis Report</title>\r\n\r\n<style>\r\n  /* —— Global & Page Settings —— */\r\n  :root {\r\n    --border-color: #ddd;\r\n    --focus: #3b82f6;\r\n    --bg-body: #f9f9f9;\r\n    --danger: #e74c3c;\r\n  }\r\n  \r\n  body { \r\n    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; \r\n    color: #444; \r\n    background-color: var(--bg-body); \r\n    font-size: 13px; \r\n    margin: 20px;\r\n  }\r\n\r\n  /* —— Dashboard KPI Grid —— */\r\n  .dashboard-grid {\r\n    display: grid;\r\n    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));\r\n    gap: 15px;\r\n    margin-bottom: 20px;\r\n  }\r\n\r\n  .stat-card {\r\n    background: #fff;\r\n    border-radius: 8px;\r\n    padding: 12px 15px;\r\n    display: flex;\r\n    align-items: center;\r\n    box-shadow: 0 1px 3px rgba(0,0,0,0.05);\r\n    border: 1px solid #e1e4e8;\r\n  }\r\n  \r\n  .stat-icon {\r\n    width: 40px; height: 40px;\r\n    border-radius: 8px;\r\n    display: flex; align-items: center; justify-content: center;\r\n    margin-right: 12px; flex-shrink: 0;\r\n  }\r\n  .stat-icon svg { width: 20px; height: 20px; }\r\n\r\n  .stat-content { display: flex; flex-direction: column; }\r\n  .stat-value { font-size: 20px; font-weight: 700; line-height: 1.2; color: #2c3e50; }\r\n  .stat-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: #8898aa; margin-top: 2px;}\r\n\r\n  /* KPI Colors */\r\n  .card-total .stat-icon { background-color: #ebedef; color: #5d6d7e; }\r\n  .card-critical .stat-icon { background-color: #fadbd8; color: #e74c3c; }\r\n  .card-critical .stat-value { color: #e74c3c; }\r\n  .card-warning .stat-icon { background-color: #fcf3cf; color: #f1c40f; }\r\n  .card-warning .stat-value { color: #d4ac0d; }\r\n  .card-info .stat-icon { background-color: #d6eaf8; color: #3498db; }\r\n  .card-info .stat-value { color: #2980b9; }\r\n  .card-open .stat-icon { background-color: #e5e8e8; color: #7f8c8d; }\r\n  .card-open .stat-value { color: #5f6a6a; }\r\n  .card-resolved .stat-icon { background-color: #d5f5e3; color: #2ecc71; }\r\n  .card-resolved .stat-value { color: #27ae60; }\r\n\r\n  /* —— Time Controls —— */\r\n  .time-controls {\r\n    background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #e1e4e8;\r\n    margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;\r\n    box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-size: 12px;\r\n  }\r\n  .btn-group { display: flex; border-radius: 4px; overflow: hidden; border: 1px solid #ddd; }\r\n  .btn-group button { padding: 5px 10px; border: none; background: #f8f9fa; cursor: pointer; border-right: 1px solid #ddd; font-weight: 600; color: #555; font-size: 11px; }\r\n  .btn-group button:last-child { border-right: none; }\r\n  .btn-group button:hover { background: #e2e6ea; }\r\n  .btn-group button.active { background: #34495e; color: white; }\r\n\r\n  /* Reset Button */\r\n  .btn-reset {\r\n    padding: 6px 12px; border: 1px solid #e74c3c; background: #fff; color: #e74c3c;\r\n    border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px;\r\n    transition: all 0.2s; display: flex; align-items: center; gap: 5px;\r\n  }\r\n  .btn-reset:hover { background: #e74c3c; color: #fff; }\r\n\r\n  /* —— New Table Styles —— */\r\n  .table-wrap {\r\n    overflow-x: auto;\r\n    border: 1px solid #ddd;\r\n    border-radius: 8px;\r\n    background: #fff;\r\n    box-shadow: 0 1px 3px rgba(0,0,0,0.05);\r\n    height: 600px; /* Fixed height for sticky headers */\r\n  }\r\n\r\n  table.vt { width: 100%; border-collapse: collapse; font-size: 12px; }\r\n  \r\n  /* Sticky Header Setup */\r\n  table.vt > thead {\r\n    position: sticky;\r\n    top: 0;\r\n    z-index: 10;\r\n    background: #fafafa;\r\n  }\r\n\r\n  table.vt th { \r\n    white-space: nowrap; \r\n    padding: 8px 10px; \r\n    border-bottom: 1px solid #eee; \r\n    background: #f8f9fa;\r\n    text-align: left;\r\n    font-weight: 600;\r\n    color: #495057;\r\n  }\r\n  \r\n  table.vt td { \r\n    white-space: normal; \r\n    padding: 8px 10px; \r\n    border-bottom: 1px solid #eee; \r\n    vertical-align: top;\r\n    color: #333;\r\n  }\r\n  table.vt tbody tr:hover td { background-color: #f8f9fa; }\r\n\r\n  /* Search & Filter UI Components */\r\n  .th-inner { display: flex; flex-direction: column; gap: 6px; min-height: 48px; }\r\n  .th-title { display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none; }\r\n  .sort-ind { opacity: .5; font-size: 10px; }\r\n\r\n  /* Combo Box / Picker Styles */\r\n  .combo {\r\n    position: relative; display:flex; align-items:center; gap:6px;\r\n    border:1px solid #ddd; border-radius:6px; background:#fff;\r\n    padding:2px 6px;\r\n    width: 100%;\r\n    box-sizing: border-box;\r\n  }\r\n  .combo:focus-within { border-color: var(--focus); box-shadow: 0 0 0 2px rgba(59,130,246,.12); }\r\n  .combo-input { \r\n    flex: 1 1 auto; border: 0; outline: 0; font-size: 11px; padding: 4px 0; background: transparent; min-width: 0; \r\n  }\r\n  .combo-right { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }\r\n  .combo-btn {\r\n    display:inline-flex; align-items:center; border:0; background:transparent; \r\n    cursor:pointer; padding:2px; opacity: 0.6;\r\n  }\r\n  .combo-btn:hover { opacity: 1; background: #eee; border-radius: 4px; }\r\n  .chev { width:12px; height:12px; }\r\n  \r\n  .badge-count {\r\n    font-size:10px; padding:1px 5px; border-radius:999px;\r\n    background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe;\r\n    white-space: nowrap;\r\n  }\r\n\r\n  /* Clear Button inside combo */\r\n  .clear-filter-btn {\r\n    position: absolute;\r\n    top: -6px;\r\n    right: -6px;\r\n    width: 16px; height: 16px; border-radius: 50%; background: #e53e3e; color: white;\r\n    border: none; cursor: pointer; display: none; align-items: center; justify-content: center;\r\n    font-size: 10px; line-height: 1; padding: 0;\r\n    z-index: 5;\r\n  }\r\n\r\n  /* Popover */\r\n  .popover {\r\n    position: fixed; min-width: 200px; max-width: 300px; max-height: 300px; overflow: auto;\r\n    background: #fff; border: 1px solid #ddd; border-radius: 6px;\r\n    box-shadow: 0 4px 12px rgba(0,0,0,.15); padding: 5px; z-index: 9999;\r\n  }\r\n  .opt { display: flex; align-items: center; gap: 8px; padding: 5px 8px; cursor: pointer; }\r\n  .opt:hover { background: #f1f5f9; border-radius: 4px; }\r\n  .opt label { font-size: 11px; cursor: pointer; flex: 1; user-select: none; }\r\n  \r\n  /* Status & Severity Badges */\r\n  .badge { padding: 3px 8px; border-radius: 12px; font-weight: 700; font-size: 10px; text-transform: uppercase; display: inline-block; letter-spacing: 0.5px; white-space: nowrap;}\r\n  \r\n  .bg-error { background-color: #ffebee; color: #c0392b; border: 1px solid #ffcdd2; }\r\n  .bg-warning { background-color: #fff8e1; color: #f39c12; border: 1px solid #ffecb3; }\r\n  .bg-info { background-color: #e3f2fd; color: #2980b9; border: 1px solid #bbdefb; }\r\n  \r\n  .bg-resolved { background-color: #e8f5e9; color: #27ae60; border: 1px solid #c8e6c9; }\r\n  .bg-open { background-color: #f2f3f4; color: #7f8c8d; border: 1px solid #e0e0e0; }\r\n\r\n  #loading { display:flex; justify-content:center; align-items:center; height:150px; font-size:16px; font-weight:bold; color: #888; }\r\n</style>\r\n\r\n<h2>Alert Analysis Report</h2>\r\n\r\n<!-- Modern Stats Grid -->\r\n<div class=\"dashboard-grid\">\r\n  <!-- Total Card -->\r\n  <div class=\"stat-card card-total\">\r\n    <div class=\"stat-icon\"><svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><line x1=\"8\" y1=\"6\" x2=\"21\" y2=\"6\"></line><line x1=\"8\" y1=\"12\" x2=\"21\" y2=\"12\"></line><line x1=\"8\" y1=\"18\" x2=\"21\" y2=\"18\"></line><line x1=\"3\" y1=\"6\" x2=\"3.01\" y2=\"6\"></line><line x1=\"3\" y1=\"12\" x2=\"3.01\" y2=\"12\"></line><line x1=\"3\" y1=\"18\" x2=\"3.01\" y2=\"18\"></line></svg></div>\r\n    <div class=\"stat-content\"><span class=\"stat-value\" id=\"kpiTotal\">0</span><span class=\"stat-label\">Total Shown</span></div>\r\n  </div>\r\n  <!-- Critical Card -->\r\n  <div class=\"stat-card card-critical\">\r\n    <div class=\"stat-icon\"><svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><circle cx=\"12\" cy=\"12\" r=\"10\"></circle><line x1=\"12\" y1=\"8\" x2=\"12\" y2=\"12\"></line><line x1=\"12\" y1=\"16\" x2=\"12.01\" y2=\"16\"></line></svg></div>\r\n    <div class=\"stat-content\"><span class=\"stat-value\" id=\"kpiError\">0</span><span class=\"stat-label\">Error</span></div>\r\n  </div>\r\n  <!-- Warning Card -->\r\n  <div class=\"stat-card card-warning\">\r\n    <div class=\"stat-icon\"><svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z\"></path><line x1=\"12\" y1=\"9\" x2=\"12\" y2=\"13\"></line><line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"></line></svg></div>\r\n    <div class=\"stat-content\"><span class=\"stat-value\" id=\"kpiWarning\">0</span><span class=\"stat-label\">Warnings</span></div>\r\n  </div>\r\n  <!-- Info Card -->\r\n  <div class=\"stat-card card-info\">\r\n    <div class=\"stat-icon\"><svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><circle cx=\"12\" cy=\"12\" r=\"10\"></circle><line x1=\"12\" y1=\"16\" x2=\"12\" y2=\"12\"></line><line x1=\"12\" y1=\"8\" x2=\"12.01\" y2=\"8\"></line></svg></div>\r\n    <div class=\"stat-content\"><span class=\"stat-value\" id=\"kpiInfo\">0</span><span class=\"stat-label\">Info</span></div>\r\n  </div>\r\n  <!-- Open Card -->\r\n  <div class=\"stat-card card-open\">\r\n    <div class=\"stat-icon\"><svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><circle cx=\"12\" cy=\"12\" r=\"10\"></circle><polyline points=\"12 6 12 12 16 14\"></polyline></svg></div>\r\n    <div class=\"stat-content\"><span class=\"stat-value\" id=\"kpiOpen\">0</span><span class=\"stat-label\">Open</span></div>\r\n  </div>\r\n  <!-- Resolved Card -->\r\n  <div class=\"stat-card card-resolved\">\r\n    <div class=\"stat-icon\"><svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><polyline points=\"20 6 9 17 4 12\"></polyline></svg></div>\r\n    <div class=\"stat-content\"><span class=\"stat-value\" id=\"kpiResolved\">0</span><span class=\"stat-label\">Resolved</span></div>\r\n  </div>\r\n</div>\r\n\r\n<!-- Time Filters -->\r\n<div class=\"time-controls\">\r\n  <!-- Reset Button Added Here -->\r\n  <button class=\"btn-reset\" onclick=\"resetFilters()\">\r\n    <svg viewBox=\"0 0 24 24\" width=\"14\" height=\"14\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><polyline points=\"23 4 23 10 17 10\"></polyline><polyline points=\"1 20 1 14 7 14\"></polyline><path d=\"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15\"></path></svg>\r\n    Reset Filters\r\n  </button>\r\n  \r\n  <div style=\"width:1px; height:20px; background:#ddd; margin:0 5px;\"></div>\r\n\r\n  <strong>Date Range:</strong>\r\n  <div class=\"btn-group\">\r\n    <button onclick=\"setDatePreset('day')\">24 Hours</button>\r\n    <button onclick=\"setDatePreset('week')\">7 Days</button>\r\n    <button onclick=\"setDatePreset('month')\">30 Days</button>\r\n    <button onclick=\"setDatePreset('all')\">All Time</button>\r\n  </div>\r\n  <span style=\"margin-left:auto; color:#666;\">From:</span>\r\n  <input type=\"datetime-local\" id=\"filterStartDate\" style=\"border:1px solid #ddd; border-radius:4px; padding:3px;\">\r\n  <span style=\"color:#666;\">To:</span>\r\n  <input type=\"datetime-local\" id=\"filterEndDate\" style=\"border:1px solid #ddd; border-radius:4px; padding:3px;\">\r\n</div>\r\n\r\n<div id=\"loading\">Processing Alerts...</div>\r\n\r\n<!-- Main Table Container -->\r\n<div class=\"table-wrap\" id=\"tableWrap\" style=\"display:none\">\r\n  <table class=\"vt\" id=\"alertTable\">\r\n    <thead id=\"vtHead\"></thead>\r\n    <tbody id=\"vtBody\"></tbody>\r\n  </table>\r\n</div>\r\n\r\n<!-- DATA GENERATION -->\r\n<script id=\"alerts-json\" type=\"application/json\">\r\n[\r\n{% for item in data_sources.allFieldsAlerts %}\r\n  {\r\n    \"severity\": {{ item.severity | tojson }},\r\n    \"severityHTML\": {% if item.severity == 'error' %}\r\n        \"<span class='badge bg-error'>Error</span>\"\r\n      {% elif item.severity == 'warning' %}\r\n        \"<span class='badge bg-warning'>Warn</span>\"\r\n      {% else %}\r\n        \"<span class='badge bg-info'>Info</span>\"\r\n      {% endif %},\r\n    \"client\": {{ item.agent__site__client__name | tojson }},\r\n    \"site\": {{ item.agent__site__name | tojson }},\r\n    \"hostname\": {{ item.agent__hostname | tojson }},\r\n    \"status\": \"{{ 'Resolved' if item.resolved else 'Open' }}\",\r\n    \"statusHTML\": {% if item.resolved %}\r\n        \"<span class='badge bg-resolved'>Resolved</span>\"\r\n      {% else %}\r\n        \"<span class='badge bg-open'>Open</span>\"\r\n      {% endif %},\r\n    \"alert_time\": {{ (item.alert_time | string) | tojson }},\r\n    \"message\": {{ item.message | tojson }}\r\n  }{{ ',' if not loop.last else '' }}\r\n{% endfor %}\r\n]\r\n</script>\r\n\r\n<!-- LOGIC -->\r\n<script>\r\n  // Utilities\r\n  var $ = function(s,r){return(r||document).querySelector(s);};\r\n  var debounce = function(fn,ms){var t;return function(){var a=arguments;clearTimeout(t);t=setTimeout(function(){fn.apply(null,a);},ms||200);};};\r\n  var htmlNode = function(s){var el=document.createElement('span');el.innerHTML=String(s||'');return el;};\r\n  var stripHtml = function(s){var d=document.createElement('div');d.innerHTML=String(s||'');return d.textContent||d.innerText||'';};\r\n  \r\n  // Storage Key\r\n  var STORAGE_KEY = 'TRMM_ALERTS_REPORT_V1';\r\n\r\n  // 1. Data Loading\r\n  var rawData = JSON.parse(document.getElementById('alerts-json').textContent || '[]');\r\n  \r\n  // Pre-process dates\r\n  for(var i=0; i<rawData.length; i++){\r\n    rawData[i].dateObj = new Date(rawData[i].alert_time);\r\n  }\r\n\r\n  // 2. Column Configuration\r\n  var columns = [\r\n    { id:'severityHTML', title:'Severity', html:true, filter:true, filterKey:'severity', width:'80px' },\r\n    { id:'client',       title:'Client',   html:false, filter:true, width:'150px' },\r\n    { id:'site',         title:'Site',     html:false, filter:true, width:'150px' },\r\n    { id:'hostname',     title:'Agent',    html:false, filter:true, width:'160px' },\r\n    { id:'statusHTML',   title:'Status',   html:true, filter:true, filterKey:'status', width:'90px' },\r\n    { id:'alert_time',   title:'Time',     html:false, filter:false, sortable:true, width:'140px' },\r\n    { id:'message',      title:'Message',  html:false, filter:true, width:'auto' }\r\n  ];\r\n\r\n  // 3. State Management\r\n  var defaultState = {\r\n    globalFilter: '',\r\n    columnText: {},\r\n    columnSelect: {},\r\n    dateRange: { start: null, end: null },\r\n    sorting: { id: 'alert_time', desc: true }\r\n  };\r\n  \r\n  // Initialize State (Load from LocalStorage if available)\r\n  var state = JSON.parse(JSON.stringify(defaultState)); // Deep copy\r\n  var savedState = localStorage.getItem(STORAGE_KEY);\r\n  var loadedFromStorage = false;\r\n\r\n  if (savedState) {\r\n    try {\r\n      var parsed = JSON.parse(savedState);\r\n      // Rehydrate Dates\r\n      if(parsed.dateRange.start) parsed.dateRange.start = new Date(parsed.dateRange.start);\r\n      if(parsed.dateRange.end) parsed.dateRange.end = new Date(parsed.dateRange.end);\r\n      state = parsed;\r\n      loadedFromStorage = true;\r\n    } catch(e) {\r\n      console.error(\"Failed to load saved state\", e);\r\n    }\r\n  }\r\n\r\n  var headEl = document.getElementById('vtHead');\r\n  var bodyEl = document.getElementById('vtBody');\r\n  var popoverEl = null;\r\n\r\n  // 4. Persistence\r\n  function saveState() {\r\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));\r\n  }\r\n\r\n  window.resetFilters = function() {\r\n    localStorage.removeItem(STORAGE_KEY);\r\n    state = JSON.parse(JSON.stringify(defaultState)); // Reset JS object\r\n    \r\n    // Clear Header Inputs\r\n    var inputs = document.querySelectorAll('.combo-input');\r\n    inputs.forEach(function(inp){ inp.value = ''; });\r\n    \r\n    // Default Date Preset (Month)\r\n    setDatePreset('month'); \r\n    \r\n    // Rebuild UI\r\n    buildHeader();\r\n    renderBody();\r\n  };\r\n\r\n  // 5. Comparison Helpers\r\n  function compare(a,b){\r\n    var na = a==null?'':String(a);\r\n    var nb = b==null?'':String(b);\r\n    return na.localeCompare(nb, undefined, {numeric:true, sensitivity:'base'});\r\n  }\r\n\r\n  function valueFor(row, col){\r\n    var key = (col.filterKey || col.id);\r\n    var v = row[key];\r\n    return col.html ? stripHtml(v) : v;\r\n  }\r\n\r\n  // 6. Filtering Logic\r\n  function rowPassesFilters(row){\r\n    // Date Range Filter (Global)\r\n    if(state.dateRange.start && row.dateObj < state.dateRange.start) return false;\r\n    if(state.dateRange.end && row.dateObj > state.dateRange.end) return false;\r\n\r\n    // Global Search Text\r\n    var gf = state.globalFilter.trim().toLowerCase();\r\n    if(gf){\r\n      var hit = false;\r\n      for(var i=0; i<columns.length; i++){\r\n        var c = columns[i];\r\n        if(!c.filter && c.id !== 'message') continue; \r\n        var val = String(valueFor(row, c) || '').toLowerCase();\r\n        if(val.indexOf(gf) > -1){ hit=true; break; }\r\n      }\r\n      if(!hit) return false;\r\n    }\r\n\r\n    // Column Specific Filters\r\n    for(var j=0; j<columns.length; j++){\r\n      var c = columns[j];\r\n      if(!c.filter) continue;\r\n      \r\n      var sv = state.columnSelect[c.id] || [];\r\n      var tv = (state.columnText[c.id] || '').toLowerCase();\r\n      var cell = String(valueFor(row, c) || '');\r\n      \r\n      if(sv.length > 0){ if(sv.indexOf(cell) === -1) return false; }\r\n      else if(tv){ if(cell.toLowerCase().indexOf(tv) === -1) return false; }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  function getFilteredSortedData(){\r\n    var rows = rawData.filter(rowPassesFilters);\r\n    \r\n    if(state.sorting.id){\r\n      var col = columns.find(c => c.id === state.sorting.id);\r\n      rows.sort(function(a,b){\r\n        var av, bv;\r\n        if(state.sorting.id === 'alert_time'){\r\n           av = a.dateObj.getTime();\r\n           bv = b.dateObj.getTime();\r\n        } else {\r\n           av = valueFor(a, col);\r\n           bv = valueFor(b, col);\r\n        }\r\n        var d = (state.sorting.id === 'alert_time') ? (av - bv) : compare(av, bv);\r\n        return state.sorting.desc ? -d : d;\r\n      });\r\n    }\r\n    return rows;\r\n  }\r\n\r\n // 7. Header Building\r\n  function buildHeader(){\r\n    headEl.innerHTML = '';\r\n    \r\n    // Column Headers Row\r\n    var trCols = document.createElement('tr');\r\n    columns.forEach(function(c){\r\n      var th = document.createElement('th');\r\n      if(c.width) th.style.width = c.width;\r\n      \r\n      var wrap = document.createElement('div'); wrap.className='th-inner';\r\n      \r\n      // Title + Sort\r\n      var t = document.createElement('div'); t.className='th-title'; \r\n      t.textContent = c.title;\r\n      if(c.sortable || c.filter){ \r\n        var ind = document.createElement('span'); ind.className='sort-ind';\r\n        ind.textContent = state.sorting.id === c.id ? (state.sorting.desc?'▼':'▲') : '↕';\r\n        t.appendChild(ind);\r\n        t.addEventListener('click', function(){\r\n            if(state.sorting.id !== c.id) { state.sorting.id = c.id; state.sorting.desc = false; }\r\n            else if(!state.sorting.desc) { state.sorting.desc = true; }\r\n            else { state.sorting.id = null; }\r\n            saveState(); // Save on sort\r\n            buildHeader(); renderBody();\r\n        });\r\n      }\r\n      wrap.appendChild(t);\r\n\r\n      // Filter Combo\r\n      if(c.filter){\r\n        var combo = buildCombo(c);\r\n        wrap.appendChild(combo);\r\n      }\r\n\r\n      th.appendChild(wrap);\r\n      trCols.appendChild(th);\r\n    });\r\n    headEl.appendChild(trCols);\r\n  }\r\n\r\n  function buildCombo(col){\r\n    var box = document.createElement('div'); box.className='combo';\r\n    \r\n    var input = document.createElement('input'); \r\n    input.className='combo-input'; \r\n    input.placeholder='Filter...';\r\n    // Load persisted value if exists\r\n    input.value = state.columnText[col.id] || '';\r\n\r\n    var right = document.createElement('div'); right.className='combo-right';\r\n    var badge = document.createElement('span'); badge.className='badge-count';\r\n    var cnt = (state.columnSelect[col.id]||[]).length;\r\n    badge.textContent = cnt;\r\n    badge.style.display = cnt>0 ? 'block' : 'none';\r\n\r\n    var btn = document.createElement('button'); btn.className='combo-btn';\r\n    btn.innerHTML = '<svg class=\"chev\" viewBox=\"0 0 24 24\"><path d=\"M7 10l5 5 5-5z\"/></svg>';\r\n    btn.onclick = function(e){ e.stopPropagation(); togglePopover(col.id, btn); };\r\n\r\n    var clr = document.createElement('button'); clr.className='clear-filter-btn'; clr.innerHTML='&times;';\r\n    var updateClr = function(){ \r\n       var hasV = input.value.length > 0 || (state.columnSelect[col.id]||[]).length > 0;\r\n       clr.style.display = hasV ? 'flex' : 'none';\r\n    };\r\n    updateClr();\r\n\r\n    clr.onclick = function(){\r\n      input.value=''; state.columnText[col.id]=''; state.columnSelect[col.id]=[];\r\n      updateClr();\r\n      badge.style.display='none';\r\n      saveState(); // Save on clear\r\n      renderBody();\r\n    };\r\n\r\n    input.addEventListener('input', debounce(function(e){\r\n      state.columnText[col.id] = e.target.value;\r\n      updateClr();\r\n      saveState(); // Save on text input\r\n      renderBody();\r\n    }, 200));\r\n\r\n    // Expose updater for badge\r\n    box._updateBadge = function(n){ \r\n        badge.textContent=n; badge.style.display=n>0?'block':'none'; updateClr(); \r\n    };\r\n\r\n    right.appendChild(badge); right.appendChild(btn);\r\n    box.appendChild(input); box.appendChild(clr); box.appendChild(right);\r\n    return box;\r\n  }\r\n\r\n  // 8. Popover Logic\r\n  function uniqueValues(colId, rows){\r\n    var col = columns.find(c=>c.id===colId);\r\n    var m = new Map();\r\n    rows.forEach(function(r){\r\n      var v = String(valueFor(r, col)||'');\r\n      m.set(v, (m.get(v)||0)+1);\r\n    });\r\n    var arr = Array.from(m.entries()).map(x=>({v:x[0], c:x[1]}));\r\n    arr.sort((a,b)=>compare(a.v, b.v));\r\n    return arr;\r\n  }\r\n\r\n  function togglePopover(colId, anchor){\r\n    if(popoverEl) { popoverEl.remove(); popoverEl=null; }\r\n    \r\n    var pop = document.createElement('div'); pop.className='popover';\r\n    \r\n    var contextRows = rawData.filter(function(r){\r\n        // Pass Global & Date for context options\r\n        if(state.dateRange.start && r.dateObj < state.dateRange.start) return false;\r\n        if(state.dateRange.end && r.dateObj > state.dateRange.end) return false;\r\n        var gf = state.globalFilter.trim().toLowerCase();\r\n        if(gf){ \r\n           if(JSON.stringify(r).toLowerCase().indexOf(gf) === -1) return false;\r\n        }\r\n        return true;\r\n    });\r\n\r\n    var items = uniqueValues(colId, contextRows);\r\n    var currentSel = state.columnSelect[colId] || [];\r\n\r\n    items.forEach(function(it){\r\n        var row = document.createElement('div'); row.className='opt';\r\n        var cb = document.createElement('input'); cb.type='checkbox';\r\n        cb.value = it.v;\r\n        cb.checked = currentSel.indexOf(it.v) > -1;\r\n        \r\n        var lbl = document.createElement('label'); \r\n        lbl.textContent = (it.v==='' ? '(Empty)' : it.v) + ' (' + it.c + ')';\r\n        \r\n        var onChange = function(){\r\n            var val = cb.value;\r\n            var arr = state.columnSelect[colId] || [];\r\n            if(cb.checked){ if(arr.indexOf(val)===-1) arr.push(val); }\r\n            else { var idx = arr.indexOf(val); if(idx>-1) arr.splice(idx,1); }\r\n            state.columnSelect[colId] = arr;\r\n            \r\n            // Update UI\r\n            var combo = anchor.closest('.combo');\r\n            if(combo && combo._updateBadge) combo._updateBadge(arr.length);\r\n            saveState(); // Save on selection\r\n            renderBody();\r\n        };\r\n        \r\n        cb.onchange = onChange;\r\n        row.onclick = function(e){ \r\n            if(e.target!==cb){ cb.checked=!cb.checked; onChange(); }\r\n        };\r\n\r\n        row.appendChild(cb); row.appendChild(lbl);\r\n        pop.appendChild(row);\r\n    });\r\n\r\n    document.body.appendChild(pop);\r\n    popoverEl = pop;\r\n    \r\n    var rect = anchor.getBoundingClientRect();\r\n    pop.style.top = (rect.bottom + 5) + 'px';\r\n    pop.style.left = (rect.left - 100) + 'px';\r\n    \r\n    setTimeout(function(){\r\n        document.addEventListener('click', closePop);\r\n    }, 0);\r\n  }\r\n\r\n  function closePop(e){\r\n    if(popoverEl && !popoverEl.contains(e.target)){\r\n        popoverEl.remove(); popoverEl=null;\r\n        document.removeEventListener('click', closePop);\r\n    }\r\n  }\r\n\r\n// 9. Render Table\r\n  function renderBody(){\r\n    bodyEl.innerHTML = '';\r\n    var data = getFilteredSortedData();\r\n    \r\n    updateStats(data);\r\n\r\n    data.forEach(function(row){\r\n        var tr = document.createElement('tr');\r\n        columns.forEach(function(col){\r\n            var td = document.createElement('td');\r\n            var val = row[col.id];\r\n            if(col.id === 'alert_time' && row.dateObj){\r\n                val = row.dateObj.toLocaleString();\r\n            }\r\n            if(col.html) td.appendChild(htmlNode(val));\r\n            else td.textContent = val;\r\n            tr.appendChild(td);\r\n        });\r\n        bodyEl.appendChild(tr);\r\n    });\r\n  }\r\n\r\n  // 10. Stats / KPI Logic\r\n  function updateStats(rows){\r\n    var t=0, err=0, warn=0, inf=0, open=0, res=0;\r\n    \r\n    rows.forEach(r => {\r\n        t++;\r\n        if(r.severity === 'error') err++;\r\n        else if(r.severity === 'warning') warn++;\r\n        else inf++;\r\n\r\n        if(r.status === 'Resolved') res++; else open++;\r\n    });\r\n\r\n    $('#kpiTotal').innerText = t;\r\n    $('#kpiError').innerText = err;\r\n    $('#kpiWarning').innerText = warn;\r\n    $('#kpiInfo').innerText = inf;\r\n    $('#kpiOpen').innerText = open;\r\n    $('#kpiResolved').innerText = res;\r\n  }\r\n\r\n  // 11. Date Controls Logic\r\n  function toIsoString(d) {\r\n      if(!d || isNaN(d.getTime())) return \"\";\r\n      var pad = function(num) { var norm = Math.floor(Math.abs(num)); return (norm < 10 ? '0' : '') + norm; };\r\n      return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate()) + 'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());\r\n  }\r\n\r\n  window.setDatePreset = function(range){\r\n      var end = new Date();\r\n      var start = new Date();\r\n      \r\n      if(range==='day') start.setHours(start.getHours()-24);\r\n      else if(range==='week') start.setDate(start.getDate()-7);\r\n      else if(range==='month') start.setDate(start.getDate()-30);\r\n      else start = new Date('2020-01-01');\r\n\r\n      $('#filterStartDate').value = toIsoString(start);\r\n      $('#filterEndDate').value = toIsoString(end);\r\n      \r\n      state.dateRange.start = start;\r\n      state.dateRange.end = end;\r\n      \r\n      var btns = document.querySelectorAll('.btn-group button');\r\n      btns.forEach(b => b.classList.remove('active'));\r\n      if(event && event.target) event.target.classList.add('active');\r\n\r\n      saveState(); // Save Date Change\r\n      renderBody();\r\n  };\r\n  \r\n  // Listeners for manual date input changes\r\n  $('#filterStartDate').addEventListener('change', function(e){ \r\n      state.dateRange.start = new Date(e.target.value); \r\n      saveState();\r\n      renderBody(); \r\n  });\r\n  $('#filterEndDate').addEventListener('change', function(e){ \r\n      state.dateRange.end = new Date(e.target.value); \r\n      saveState();\r\n      renderBody(); \r\n  });\r\n\r\n  // —— Init ——\r\n  buildHeader();\r\n  \r\n  // Logic to determine initial dates:\r\n  if(loadedFromStorage && state.dateRange.start && state.dateRange.end){\r\n      // If we loaded dates from storage, update the input fields to match\r\n      $('#filterStartDate').value = toIsoString(state.dateRange.start);\r\n      $('#filterEndDate').value = toIsoString(state.dateRange.end);\r\n      renderBody();\r\n  } else {\r\n      // If no storage (or invalid dates), use default Month preset\r\n      setDatePreset('month'); \r\n  }\r\n\r\n  $('#loading').style.display='none';\r\n  $('#tableWrap').style.display='block';\r\n\r\n</script>\r\n\r\n{% endblock %}",
    "type": "html",
    "depends_on": [],
    "template_variables": "data_sources:\n  allFieldsAlerts:\n    model: alert\n    order_by: -alert_time\n    limit: 10000\n    only:\n      - id\n      - severity\n      - message\n      - alert_time\n      - resolved\n      - resolved_on\n      - agent__hostname\n      - agent__site__name\n      - agent__site__client__name\n    filter:\n      alert_time__gt: !now days=-90"
  },
  "assets": []
}