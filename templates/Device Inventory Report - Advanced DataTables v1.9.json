{
  "base_template": {
    "name": "TRMM_Base v1.1",
    "html": "<html>\n\n<head>\n    <style>\n        /* —— PDF page settings —— */\n        @page {\n            margin: 0.5in;\n            size: letter portrait;\n        }\n\n        /* —— Color palette (theme) —— */\n        :root {\n            --header-bg: #2c3e50;\n            --header-text: #ffffff;\n            --border-color: #dddddd;\n            --table-header-bg: #f2f2f2;\n            --status-ready-bg: #eaf7ec;\n            --status-ready-badge: #28a745;\n            --status-not-ready-bg: #fbebee;\n            --status-not-ready-badge: #dc3545;\n            --status-unknown-bg: #fff9e6;\n            --status-unknown-badge: #ffc107;\n            --badge-already-bg: #17a2b8;\n        }\n\n        /* —— Typography & utilities (structure) —— */\n        body {\n            font-family: sans-serif;\n            color: #333;\n            font-size: 12px;\n        }\n\n        .section {\n            margin-top: 20px;\n        }\n\n        .text-danger {\n            color: #a94442;\n            font-weight: bold;\n        }\n\n        /* —— Header layout (structure) —— */\n        .report-header {\n            background-color: var(--header-bg);\n            color: var(--header-text);\n            padding: 20px;\n            border-radius: 8px;\n            display: flex;\n            align-items: center;\n        }\n\n        .header-logo {\n            width: 80px;\n            margin-right: 25px;\n            flex-shrink: 0;\n        }\n\n        .header-date {\n            margin-left: auto;\n            text-align: right;\n            white-space: nowrap;\n        }\n\n        .report-header h1 {\n            font-size: 24px;\n            margin: 0 0 5px;\n        }\n\n        .report-header h2 {\n            font-size: 16px;\n            margin: 0;\n            opacity: 0.9;\n        }\n\n        /* —— Standardized Table Styles (structure) —— */\n        .report-table {\n            border-collapse: collapse;\n            width: 100%;\n        }\n\n        .report-table th,\n        .report-table td {\n            border: 1px solid var(--border-color);\n            padding: 6px 8px;\n            text-align: left;\n            vertical-align: top;\n        }\n\n        .report-table thead th {\n            background-color: var(--table-header-bg);\n            font-weight: bold;\n            cursor: pointer;\n            user-select: none;\n        }\n\n        /* Header label + sort indicators */\n        .th-topline {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            gap: .4rem;\n        }\n\n        .th-label {\n            position: relative;\n            cursor: pointer;\n            user-select: none;\n        }\n\n        /* These are the specific rules that make the indicator visible */\n        th.sorted.asc .th-label::after {\n            content: \"▲\";\n            padding-left: .4rem;\n            color: #333;\n            font-size: .9em;\n        }\n\n        th.sorted.desc .th-label::after {\n            content: \"▼\";\n            padding-left: .4rem;\n            color: #333;\n            font-size: .9em;\n        }\n\n        .report-table thead th select {\n            width: 100%;\n            margin-top: 5px;\n            padding: 4px;\n            border-radius: 4px;\n            border: 1px solid #ccc;\n            font-weight: normal;\n            background: #fff;\n        }\n\n        /* —— Badge shape (structure) —— */\n        .status-badge {\n            display: inline-block;\n            padding: 4px 10px;\n            border-radius: 12px;\n            color: #fff;\n            font-weight: bold;\n            font-size: 11px;\n            text-align: center;\n            white-space: nowrap;\n        }\n\n        /* —— Stub classes for per‑report overrides —— */\n        .status-ready {}\n\n        .status-not-ready {}\n\n        .status-unknown {}\n\n        .badge-ready {}\n\n        .badge-not-ready {}\n\n        .badge-unknown {}\n\n        .badge-already {}\n    </style>\n</head>\n\n<body>\n    {% block content %}{% endblock %}\n</body>\n\n</html>"
  },
  "template": {
    "name": "Device Inventory Report - Advanced DataTables v1.9",
    "template_css": "",
    "template_md": "{% block content %}\r\n\r\n<title>Computer Inventory Report</title>\r\n\r\n<style>\r\n  @page { margin: 0.5in; size: letter landscape; }\r\n\r\n  :root {\r\n    --border-color: #ddd;\r\n    --pane-gap: 10px;\r\n    --focus: #3b82f6;\r\n  }\r\n\r\n  body { font-size: 14px !important; }\r\n\r\n  .report-header {\r\n    background: #2c3e50; color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 10px;\r\n  }\r\n\r\n  /* --- Table / unified sticky header --- */\r\n  .table-wrap {\r\n    overflow-x: auto;\r\n    border: 1px solid #ddd;\r\n  }\r\n  .container-fluid { padding-left: 0 !important; padding-right: 0 !important; }\r\n\r\n  table.vt { width: 100%; border-collapse: collapse; }\r\n  table.vt th, table.vt td { white-space: nowrap; padding: 6px 8px; border-bottom: 1px solid #eee; }\r\n  table.vt tbody td { background: #fff; }\r\n\r\n  /* Sticky THEAD (includes global search row + column header row) */\r\n  table.vt > thead {\r\n    position: sticky;\r\n    top: 0;\r\n    z-index: 10;\r\n    background: #fafafa;\r\n  }\r\n\r\n  /* AFTER: Split th and td to allow wrapping in body */\r\n  table.vt th { \r\n    white-space: nowrap; \r\n    padding: 6px 8px; \r\n    border-bottom: 1px solid #eee; \r\n  }\r\n  \r\n  table.vt td { \r\n    white-space: normal; /* Allows text to wrap */\r\n    padding: 6px 8px; \r\n    border-bottom: 1px solid #eee; \r\n    vertical-align: top; /* Aligns content to top when rows get tall */\r\n  }\r\n\r\n  /* First header row (global search) container */\r\n  .headbar {\r\n    display: flex; align-items: center; gap: 12px;\r\n    padding: 0 0;\r\n  }\r\n  .headbar .title { font-weight: 600; opacity: .85; }\r\n  .headbar .spacer { flex: 1 1 auto; }\r\n\r\n  /* === Restored global search “pill” style === */\r\n  .search-wrap { position: relative; display: inline-flex; align-items: center; }\r\n  .search-input {\r\n    width: clamp(260px, 34vw, 520px);\r\n    padding: 6px 30px;\r\n    border: 1px solid var(--border-color);\r\n    border-radius: 24px;\r\n    font-size: 12px;\r\n    outline: none;\r\n    background: #fff;\r\n  }\r\n  .search-input:focus { border-color: var(--focus); box-shadow: 0 0 0 2px rgba(59,130,246,.12); }\r\n  .search-icon, .search-clear { position: absolute; width: 16px; height: 16px; opacity: .6; }\r\n  .search-icon { left: 10px; pointer-events: none; }\r\n  .search-clear { display: none !important; } /* Hide original clear icon */\r\n\r\n  /* Column header UX */\r\n  .th-inner { display: flex; flex-direction: column; gap: 6px; min-height: 48px; }\r\n  .th-title { display: flex; align-items: center; gap: 6px; font-weight: 600; }\r\n  th.sortable { cursor: pointer; user-select: none; }\r\n  th.sortable .sort-ind { opacity: .6; margin-left: 4px; }\r\n\r\n  /* Filter controls (per-column) */\r\n  .filter-wrap { position: relative; display: flex; align-items: center; gap: 6px; }\r\n  .filter-stack { display: flex; flex-direction: column; gap: 4px; width: 320px; }\r\n  .filter-row { display: flex; align-items: center; gap: 6px; }\r\n  .filter-input {\r\n    width: 100%; box-sizing: border-box; padding: 4px 6px;\r\n    border: 1px solid #ddd; border-radius: 6px; font-size: 12px; background: #fff;\r\n  }\r\n  .chipbar { display: flex; flex-wrap: wrap; gap: 4px; }\r\n  .chip { font-size: 11px; padding: 2px 6px; border: 1px solid #e2e8f0; border-radius: 999px; background: #f8fafc; }\r\n\r\n  /* Popover (picker) */\r\n  .popover {\r\n    position: fixed; min-width: 260px; max-width: 380px; max-height: 280px; overflow: auto;\r\n    background: #fff; border: 1px solid #ddd; border-radius: 8px;\r\n    box-shadow: 0 8px 24px rgba(0,0,0,.12); padding: 8px; z-index: 10000;\r\n  }\r\n  .opt { display: flex; align-items: center; gap: 8px; padding: 4px 2px; }\r\n  .opt label { flex: 1 1 auto; font-size: 12px; }\r\n\r\n  /* Unified combo for column pickers (unchanged) */\r\n  .combo{\r\n    position: relative; /* For clear button positioning */\r\n    display:flex; align-items:center; gap:6px;\r\n    border:1px solid #ddd; border-radius:8px; background:#fff;\r\n    padding:2px 8px;\r\n  }\r\n  .combo:focus-within{ border-color: var(--focus); box-shadow: 0 0 0 2px rgba(59,130,246,.12); }\r\n  .combo-input { \r\n    flex: 1 1 auto; \r\n    border: 0; \r\n    outline: 0; \r\n    font-size: 12px; \r\n    padding: 6px 6px; \r\n    background: transparent; \r\n    \r\n    /* ADD THIS: Allows the input to shrink smaller than default to fit narrow columns */\r\n    min-width: 0; \r\n  }\r\n\r\n  .combo-right { \r\n    display: flex; \r\n    align-items: center; \r\n    gap: 6px; \r\n    \r\n    /* ADD THIS: Ensures the arrow/badge are never squashed or pushed off */\r\n    flex-shrink: 0; \r\n  }\r\n  .combo-btn{\r\n    display:inline-flex; align-items:center; gap:4px;\r\n    border:0; background:transparent; cursor:pointer; padding:4px; border-radius:6px;\r\n  }\r\n  .combo-btn:hover{ background:#f1f5f9; }\r\n  .chev{ width:14px; height:14px; opacity:.7; }\r\n  .badge{\r\n    font-size:11px; padding:2px 6px; border-radius:999px;\r\n    background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe;\r\n  }\r\n\r\n/* New Clear Button Styling */\r\n  .clear-filter-btn {\r\n    position: absolute;\r\n    top: 0;\r\n    right: 0;\r\n    transform: translate(50%, -50%);\r\n    width: 18px;\r\n    height: 18px;\r\n    border-radius: 50%;\r\n    background: #e53e3e;\r\n    color: white;\r\n    border: none;\r\n    cursor: pointer;\r\n    display: none; /* JS will toggle to 'flex' */\r\n    align-items: center;\r\n    justify-content: center;\r\n    font-family: sans-serif;\r\n    font-size: 13px;\r\n    font-weight: bold;\r\n    line-height: 18px;\r\n    padding: 0;\r\n    z-index: 5;\r\n  }\r\n  .clear-filter-btn:hover { background: #c53030; }\r\n  .combo .clear-filter-btn { right: 0px; } /* Position for combo boxes with dropdown arrow */\r\n\r\n  /* Operating System (Column 3) */\r\n  #computerTable th:nth-child(3) {\r\n    width: 140px;          /* Sets the visual width of the header */\r\n    max-width: 140px;      /* Prevents header from expanding */\r\n    overflow: visible;     /* KEEPS DROPDOWN/SEARCH VISIBLE */\r\n    white-space: normal;   /* Allows header title to wrap if needed */\r\n  }\r\n  #computerTable td:nth-child(3) {\r\n    max-width: 140px;      /* Wraps the data text */\r\n    word-wrap: break-word;\r\n    white-space: normal;\r\n  }\r\n\r\n  /* RAM (Column 6) */\r\n  #computerTable th:nth-child(6), #computerTable td:nth-child(6) {\r\n    min-width: 80px;\r\n    text-align: center;\r\n  }\r\n\r\n  /* Serial # (Column 7) */\r\n  #computerTable th:nth-child(7) {\r\n    width: 110px;\r\n    max-width: 110px;\r\n    overflow: visible;\r\n  }\r\n  #computerTable td:nth-child(7) {\r\n    max-width: 110px;\r\n    text-align: right;\r\n    word-break: break-all; /* Force wrap for long alphanumeric serials */\r\n    white-space: normal;\r\n  }\r\n\r\n  #loading { display:flex; justify-content:center; align-items:center; height:150px; font-size:16px; font-weight:bold; }\r\n\r\n  /* Print: disable sticky so thead repeats cleanly */\r\n  @media print {\r\n    table.vt > thead { position: static; }\r\n  }\r\n</style>\r\n\r\n<div class=\"container-fluid\">\r\n  <div class=\"report-header d-flex align-items-center\">\r\n    <div class=\"header-logo mr-3\">\r\n      <img src=\"https://github.com/amidaware/reporting-templates/blob/master/assets/gbtnavy%20(256).png?raw=true\" alt=\"Amidaware Logo\" style=\"width: 80px; height: auto;\">\r\n    </div>\r\n    <div class=\"header-titles\">\r\n      <h1 class=\"mb-1\">Computer Inventory Report</h1>\r\n      <h2 id=\"report-subtitle\" class=\"m-0\" style=\"opacity:.9;\">Client: {{ client.name if client and client.name else 'All' }} | Site: All</h2>\r\n      <div class=\"row-count mt-2\" aria-live=\"polite\" style=\"font-size:13px;\">\r\n        Filtered Row Count: <strong><span id=\"visibleCount\">0</span></strong>\r\n        of <span id=\"totalCount\">{{ data_sources.agentsList | length }}</span>\r\n      </div>\r\n    </div>\r\n    <div class=\"header-date ml-auto\" style=\"white-space:nowrap;\">\r\n      <h2 class=\"m-0\">{{ report_run_timestamp.strftime('%B %d, %Y') if report_run_timestamp else datetime.date.today().strftime('%B %d, %Y') }}</h2>\r\n    </div>\r\n  </div>\r\n\r\n  <div id=\"loading\">Loading...</div>\r\n\r\n  <div class=\"table-wrap\" id=\"tableWrap\" style=\"display:none\">\r\n    <table class=\"vt\" id=\"computerTable\" role=\"table\" aria-label=\"Computer inventory\">\r\n      <thead id=\"vtHead\"></thead>\r\n      <tbody id=\"vtBody\"></tbody>\r\n    </table>\r\n  </div>\r\n</div>\r\n\r\n{% macro wrap_text(text, limit=25) -%}\r\n  {%- if text and text|length > limit -%}\r\n    {{ text[:limit] }}<wbr>{{ text[limit:] }}\r\n  {%- else -%}\r\n    {{ text if text else 'N/A' }}\r\n  {%- endif -%}\r\n{%- endmacro %}\r\n\r\n{% macro os_slim(os) -%}\r\n  {%- if os -%}\r\n    {%- set clean = os|replace(\",\", \"\") -%}\r\n    {%- if 'Windows 10' in clean or 'Windows 11' in clean -%}\r\n      {%- set parts = clean.split(' ') -%}{{ parts[:3] | join(' ') }}\r\n    {%- elif 'Windows Server' in clean -%}\r\n      {%- set parts = clean.split(' ') -%}{{ parts[:4] | join(' ') }}\r\n    {%- else -%}\r\n      {{ clean }}\r\n    {%- endif -%}\r\n  {%- else -%}N/A{%- endif -%}\r\n{%- endmacro %}\r\n\r\n<script id=\"inventory-json\" type=\"application/json\">\r\n[\r\n{% for item in data_sources.agentsList %}\r\n  {\r\n    \"clientRaw\": {{ (item.site__client__name or (client.name if client and client.name else 'N/A')) | tojson }},\r\n    \"site\": {{ (item.site__name or 'N/A') | tojson }},\r\n    \"clientSiteHTML\": {{ (\r\n      (item.site__client__name or (client.name if client and client.name else 'N/A'))\r\n      ~ '<br><span style=\"opacity:.75;\">' ~ (item.site__name or 'N/A') ~ '</span>'\r\n    ) | tojson }},\r\n    \"deviceHTML\": {{ (\r\n      (wrap_text(item.hostname if item.hostname else 'N/A'))\r\n      ~ '<br><span style=\\\"opacity:.75;\\\">' ~ (item.last_logged_in_user if item.last_logged_in_user else 'N/A') ~ '</span>'\r\n    ) | tojson }},\r\n    \"device\": {{ (item.hostname if item.hostname else 'N/A') | tojson }},\r\n    \"os\": {{ (os_slim(item.operating_system if item.operating_system else 'N/A')) | tojson }},\r\n    \"manufacturer\": {{ (\r\n      item.wmi_detail.comp_sys[0][0].Manufacturer\r\n      if item.wmi_detail and item.wmi_detail.comp_sys and item.wmi_detail.comp_sys[0] and item.wmi_detail.comp_sys[0][0]\r\n      and item.wmi_detail.comp_sys[0][0].Manufacturer else 'N/A'\r\n    ) | tojson }},\r\n    \"model\": {{ (\r\n      (item.wmi_detail.comp_sys_prod[0][0].Version\r\n        if item.wmi_detail and item.wmi_detail.comp_sys and item.wmi_detail.comp_sys[0] and item.wmi_detail.comp_sys[0][0]\r\n        and item.wmi_detail.comp_sys[0][0].Manufacturer == 'LENOVO' and item.wmi_detail.comp_sys_prod\r\n        and item.wmi_detail.comp_sys_prod[0] and item.wmi_detail.comp_sys_prod[0][0]\r\n        else (item.wmi_detail.comp_sys[0][0].Model\r\n          if item.wmi_detail and item.wmi_detail.comp_sys and item.wmi_detail.comp_sys[0] and item.wmi_detail.comp_sys[0][0]\r\n          and item.wmi_detail.comp_sys[0][0].Model else 'N/A'))\r\n    ) | tojson }},\r\n    \"ram\": {{ ((item.total_ram|string) ~ 'GB') | tojson }},\r\n    \"serial\": {{ (\r\n      item.wmi_detail.bios[0][0].SerialNumber\r\n      if item.wmi_detail and item.wmi_detail.bios and item.wmi_detail.bios[0] and item.wmi_detail.bios[0][0]\r\n      and item.wmi_detail.bios[0][0].SerialNumber else 'N/A'\r\n    ) | tojson }},\r\n    \"batteryHTML\":\r\n      {% set battery= item.get('custom_fields', {}).get('BatteryHealthPercentage') %}\r\n      {% if battery is not none and battery|string|trim != '' %}\r\n        {% if 'No battery present on this system.' in battery or battery == 'update custom_field' %}\r\n          {{ '\\\"update custom_field\\\"' }}\r\n        {% else %}\r\n          {% set val = (battery|string)|int(default=0) %}\r\n          {{ ('\\\"<span style=\\\\\\\"color:' ~ ('red' if val<60 else ('orange' if val<80 else 'green')) ~ ';\\\\\\\">' ~ val|string ~ '%</span>\\\"') | safe }}\r\n        {% endif %}\r\n      {% else %}\r\n        {{ '\\\"update custom_field\\\"' }}\r\n      {% endif %},\r\n    \"warrantyHTML\":\r\n      {% set warranty = item.get('custom_fields', {}).get('WarrantyExpiration') %}\r\n      {% if warranty and warranty|string|trim != '' %}\r\n        {% set raw = warranty.split('.')[0] %}\r\n        {% set fmt = '%Y-%m-%dT%H:%M:%S' if 'T' in raw else '%Y-%m-%d' %}\r\n        {% set wdate = datetime.datetime.strptime(raw, fmt).date() %}\r\n        {% set diff = (wdate - datetime.date.today()).days %}\r\n        {% set disp = wdate.strftime('%Y-%m-%d') %}\r\n        {{ ('\\\"<span style=\\\\\\\"color:' ~ ('green' if diff>90 else ('orange' if diff>0 else 'red')) ~ ';\\\\\\\">' ~ disp ~ '</span>\\\"') | safe }}\r\n      {% else %}\r\n        {{ '\\\"update custom_field\\\"' }}\r\n      {% endif %}\r\n  }{{ ',' if not loop.last else '' }}\r\n{% endfor %}\r\n]\r\n</script>\r\n\r\n<script>\r\n  var $=function(s,r){return(r||document).querySelector(s);};\r\n  var $$=function(s,r){return Array.prototype.slice.call((r||document).querySelectorAll(s));};\r\n  var debounce=function(fn,ms){var t;return function(){var a=arguments;clearTimeout(t);t=setTimeout(function(){fn.apply(null,a);},ms||200);};};\r\n  var htmlNode=function(s){var el=document.createElement('span');el.innerHTML=String(s||'');return el;};\r\n  var stripHtml=function(s){var d=document.createElement('div');d.innerHTML=String(s||'');return d.textContent||d.innerText||'';};\r\n\r\n  var data=JSON.parse(document.getElementById('inventory-json').textContent||'[]');\r\n  for(var i=0;i<data.length;i++){\r\n    data[i].batteryHTMLText=stripHtml(data[i].batteryHTML);\r\n    data[i].warrantyHTMLText=stripHtml(data[i].warrantyHTML);\r\n    var m=String(data[i].ram||'').match(/\\d+/);\r\n    data[i].ramNum=m?parseFloat(m[0]):null;\r\n  }\r\n\r\n  var columns=[\r\n    { id:'clientSiteHTML', title:'Client / Site', html:true,  filter:true, selectable:true,  sortable:false, special:'clientSite' },\r\n    { id:'deviceHTML',     title:'Device Name',   html:true,  filter:true, selectable:true,  sortable:true,  filterKey:'device' },\r\n    { id:'os',             title:'Operating System', html:false, filter:true, selectable:true, sortable:true },\r\n    { id:'manufacturer',   title:'Manufacturer',  html:false, filter:true, selectable:true,  sortable:true  },\r\n    { id:'model',          title:'Model',         html:false, filter:true, selectable:true,  sortable:true  },\r\n    { id:'ram',            title:'RAM',           html:false, filter:true, selectable:false, sortable:true, numeric:true, range:true },\r\n    { id:'serial',         title:'Serial #',      html:false, filter:true, selectable:true,  sortable:true  },\r\n    { id:'batteryHTML',    title:'Battery Health',html:true,  filter:true, selectable:true,  sortable:true, filterKey:'batteryHTMLText' },\r\n    { id:'warrantyHTML',   title:'Warranty Expiration', html:true, filter:true, selectable:true, sortable:true, filterKey:'warrantyHTMLText' }\r\n  ];\r\n\r\n  var state={\r\n    globalFilter:'', columnText:{}, columnSelect:{}, range:{},\r\n    clientSite:{ textClient:'', textSite:'', selClient:[], selSite:[] },\r\n    sorting:{id:null,desc:false}\r\n  };\r\n\r\n  var headEl=document.getElementById('vtHead');\r\n  var bodyEl=document.getElementById('vtBody');\r\n\r\n  function compare(a,b){\r\n    var na=a==null?'':String(a);\r\n    var nb=b==null?'':String(b);\r\n    return na.localeCompare(nb,undefined,{numeric:true,sensitivity:'base'});\r\n  }\r\n\r\n  function valueFor(row,col){\r\n    var key=(col.filterKey||col.id);\r\n    var v=row[key];\r\n    return col.html?stripHtml(v):v;\r\n  }\r\n\r\n  function rowPassesFilters(row){\r\n    var gf=state.globalFilter.trim().toLowerCase();\r\n    if(gf){\r\n      var hit=false;\r\n      for(var i=0;i<columns.length;i++){\r\n        var c=columns[i]; if(!c.filter) continue;\r\n        if(c.special==='clientSite'){\r\n          var t1=String(row.clientRaw||'').toLowerCase();\r\n          var t2=String(row.site||'').toLowerCase();\r\n          if(t1.indexOf(gf)>-1 || t2.indexOf(gf)>-1){ hit=true; break; }\r\n        } else {\r\n          var t=String(valueFor(row,c)||'').toLowerCase();\r\n          if(t.indexOf(gf)>-1){ hit=true; break; }\r\n        }\r\n      }\r\n      if(!hit) return false;\r\n    }\r\n    for(var j=0;j<columns.length;j++){\r\n      var c=columns[j]; if(!c.filter) continue;\r\n\r\n      if(c.range){\r\n        var r=state.range[c.id]||{};\r\n        var num=row.ramNum;\r\n        if(r.min!=null && (num==null || num<r.min)) return false;\r\n        if(r.max!=null && (num==null || num>r.max)) return false;\r\n        continue;\r\n      }\r\n\r\n      if(c.special==='clientSite'){\r\n        var s=state.clientSite;\r\n        var cellClient=String(row.clientRaw||'');\r\n        var cellSite=String(row.site||'');\r\n        if(s.selClient.length>0){ if(s.selClient.indexOf(cellClient)===-1) return false; }\r\n        else if(s.textClient){ if(cellClient.toLowerCase().indexOf(s.textClient.toLowerCase())===-1) return false; }\r\n        if(s.selSite.length>0){ if(s.selSite.indexOf(cellSite)===-1) return false; }\r\n        else if(s.textSite){ if(cellSite.toLowerCase().indexOf(s.textSite.toLowerCase())===-1) return false; }\r\n        continue;\r\n      }\r\n\r\n      var sv=state.columnSelect[c.id]||[];\r\n      var tv=(state.columnText[c.id]||'').toLowerCase();\r\n      var cell=String(valueFor(row,c)||'');\r\n      if(sv.length>0){ if(sv.indexOf(cell)===-1) return false; }\r\n      else if(tv){ if(cell.toLowerCase().indexOf(tv)===-1) return false; }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  function getFilteredSortedData(){\r\n    var rows=data.filter(rowPassesFilters);\r\n    if(state.sorting.id){\r\n      var col=columns.find(function(c){return c.id===state.sorting.id;});\r\n      rows=rows.slice().sort(function(a,b){\r\n        var av = col.numeric ? (col.id==='ram' ? a.ramNum : parseFloat(a[col.id])) : valueFor(a,col);\r\n        var bv = col.numeric ? (col.id==='ram' ? b.ramNum : parseFloat(b[col.id])) : valueFor(b,col);\r\n        if(col.numeric){\r\n          var sa = (isFinite(av)?av:Number.POSITIVE_INFINITY);\r\n          var sb = (isFinite(bv)?bv:Number.POSITIVE_INFINITY);\r\n          var d = sa - sb;\r\n          return state.sorting.desc ? -d : d;\r\n        } else {\r\n          var d2 = compare(av,bv);\r\n          return state.sorting.desc ? -d2 : d2;\r\n        }\r\n      });\r\n    }\r\n    return rows;\r\n  }\r\n\r\n  function uniqueValuesByKey(key, list){\r\n    var m=new Map();\r\n    for(var i=0;i<list.length;i++){\r\n      var val=String((key==='clientRaw'?list[i].clientRaw:list[i].site)||'N/A');\r\n      m.set(val,(m.get(val)||0)+1);\r\n    }\r\n    var arr=Array.from(m.entries()).map(function(x){return {v:x[0], c:x[1]};});\r\n    arr.sort(function(a,b){return a.v.localeCompare(b.v,undefined,{numeric:true,sensitivity:'base'});});\r\n    return arr;\r\n  }\r\n\r\nfunction uniqueValues(colId, list) {\r\n  var col = columns.find(function(c) { return c.id === colId; });\r\n  var m = new Map();\r\n  for (var i = 0; i < list.length; i++) {\r\n    var val = String(valueFor(list[i], col) || 'N/A');\r\n    m.set(val, (m.get(val) || 0) + 1);\r\n  }\r\n  var arr = Array.from(m.entries()).map(function([key, count]) {\r\n    return { v: key, c: count };\r\n  });\r\n  arr.sort(function(a, b) {\r\n    return a.v.localeCompare(b.v, undefined, { numeric: true, sensitivity: 'base' });\r\n  });\r\n  return arr;\r\n}\r\n\r\n  function filteredRowsExcluding(colId, subKey){\r\n    var saved={\r\n      columnText:Object.assign({},state.columnText),\r\n      columnSelect:JSON.parse(JSON.stringify(state.columnSelect)),\r\n      range:Object.assign({},state.range),\r\n      clientSite:JSON.parse(JSON.stringify(state.clientSite))\r\n    };\r\n    if(colId==='clientSiteHTML'){\r\n      if(subKey==='client') state.clientSite.selClient=[] , state.clientSite.textClient='';\r\n      if(subKey==='site')   state.clientSite.selSite=[] , state.clientSite.textSite='';\r\n    } else {\r\n      state.columnSelect[colId]=[];\r\n      state.columnText[colId]='';\r\n      delete state.range[colId];\r\n    }\r\n    var rows=data.filter(rowPassesFilters);\r\n    state.columnText=saved.columnText;\r\n    state.columnSelect=saved.columnSelect;\r\n    state.range=saved.range;\r\n    state.clientSite=saved.clientSite;\r\n    return rows;\r\n  }\r\n\r\n  function buildHeader(){\r\n    headEl.innerHTML='';\r\n\r\n    var trSearch=document.createElement('tr');\r\n    var thSearch=document.createElement('th'); thSearch.colSpan = columns.length;\r\n    var bar=document.createElement('div'); bar.className='headbar';\r\n    var title=document.createElement('div'); title.className='title'; title.textContent='Global Filter';\r\n\r\n    var sw=document.createElement('div'); sw.className='search-wrap';\r\n    var input=document.createElement('input'); input.id='globalSearch'; input.type='search'; input.className='search-input';\r\n    input.placeholder='Type to filter table'; input.setAttribute('aria-label','Search table');\r\n    input.value = state.globalFilter || '';\r\n\r\n    var icon=document.createElementNS('http://www.w3.org/2000/svg','svg'); icon.setAttribute('class','search-icon'); icon.setAttribute('viewBox','0 0 24 24'); icon.setAttribute('aria-hidden','true');\r\n    icon.innerHTML='<path d=\"M15.5 14h-.79l-.28-.27a6.5 6.5 0 1 0-.71.71l.27.28v.79L20 21.5 21.5 20l-6-6zm-6 0A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z\"/>';\r\n\r\n    var clearBtn = document.createElement('button');\r\n    clearBtn.className = 'clear-filter-btn';\r\n    clearBtn.innerHTML = '&times;';\r\n    clearBtn.setAttribute('aria-label', 'Clear search');\r\n\r\n    var toggleGlobalClear = function() {\r\n      clearBtn.style.display = input.value ? 'flex' : 'none';\r\n    };\r\n\r\n    input.addEventListener('input', debounce(function(e){\r\n      state.globalFilter = e.target.value || '';\r\n      toggleGlobalClear();\r\n      renderBody(); updateCount();\r\n    }, 140));\r\n\r\n    clearBtn.addEventListener('click', function(){\r\n      input.value='';\r\n      input.focus();\r\n      state.globalFilter='';\r\n      toggleGlobalClear();\r\n      renderBody(); updateCount();\r\n    });\r\n\r\n    sw.appendChild(input); sw.appendChild(icon); sw.appendChild(clearBtn);\r\n    toggleGlobalClear();\r\n\r\n    bar.appendChild(title);\r\n    bar.appendChild(sw);\r\n    bar.appendChild(document.createElement('div')).className='spacer';\r\n    thSearch.appendChild(bar);\r\n    trSearch.appendChild(thSearch);\r\n\r\n    var trCols=document.createElement('tr');\r\n\r\n    columns.forEach(function(c){\r\n      var th=document.createElement('th');\r\n      if(c.sortable) th.classList.add('sortable');\r\n      var wrap=document.createElement('div'); wrap.className='th-inner';\r\n      var t=document.createElement('div'); t.className='th-title'; t.textContent=c.title;\r\n      if(c.sortable){\r\n        var ind=document.createElement('span'); ind.className='sort-ind';\r\n        ind.textContent = state.sorting.id===c.id ? (state.sorting.desc?'▼':'▲') : '↕';\r\n        t.appendChild(ind);\r\n        t.addEventListener('click',function(){\r\n          if(state.sorting.id!==c.id){ state.sorting.id=c.id; state.sorting.desc=false; }\r\n          else if(state.sorting.id===c.id && state.sorting.desc===false){ state.sorting.desc=true; }\r\n          else { state.sorting.id=null; state.sorting.desc=false; }\r\n          buildHeader(); renderBody(); updateCount();\r\n        });\r\n      }\r\n      wrap.appendChild(t);\r\n\r\n      if(c.filter){\r\n        if(c.range){\r\n          var fw=document.createElement('div'); fw.className='filter-wrap';\r\n          var min=document.createElement('input'); min.className='filter-input'; min.placeholder='Min';\r\n          var max=document.createElement('input'); max.className='filter-input'; max.placeholder='Max';\r\n          var clearRangeBtn = document.createElement('button');\r\n          clearRangeBtn.className = 'clear-filter-btn';\r\n          clearRangeBtn.innerHTML = '&times;';\r\n          clearRangeBtn.setAttribute('aria-label', 'Clear range filter for ' + c.title);\r\n\r\n          var toggleRangeClear = function() {\r\n            var hasValue = min.value.trim() !== '' || max.value.trim() !== '';\r\n            clearRangeBtn.style.display = hasValue ? 'flex' : 'none';\r\n          };\r\n\r\n          var apply=function(){\r\n            var vmin = min.value.trim()==='' ? null : parseFloat(min.value);\r\n            var vmax = max.value.trim()==='' ? null : parseFloat(max.value);\r\n            state.range[c.id]={min:vmin,max:vmax};\r\n            toggleRangeClear();\r\n            renderBody(); updateCount();\r\n          };\r\n\r\n          clearRangeBtn.addEventListener('click', function() {\r\n              min.value = ''; max.value = '';\r\n              apply();\r\n          });\r\n\r\n          min.addEventListener('input', debounce(apply, 250));\r\n          max.addEventListener('input', debounce(apply, 250));\r\n\r\n          var r = state.range[c.id]||{};\r\n          if(r.min!=null) min.value=r.min;\r\n          if(r.max!=null) max.value=r.max;\r\n\r\n          fw.appendChild(min); fw.appendChild(max); fw.appendChild(clearRangeBtn);\r\n          wrap.appendChild(fw);\r\n          toggleRangeClear();\r\n        } else if(c.special==='clientSite'){\r\n          wrap.appendChild(buildCombo({\r\n            title: 'Client',\r\n            placeholder:'Search client',\r\n            getText:()=>state.clientSite.textClient||'',\r\n            setText:(v)=>{ state.clientSite.textClient=v||''; if(!(state.clientSite.selClient||[]).length){ renderBody(); updateCount(); } },\r\n            getCount:()=> (state.clientSite.selClient||[]).length,\r\n            open:(btn)=> togglePopoverDual('client', btn),\r\n            clear:()=>{ state.clientSite.textClient=''; state.clientSite.selClient=[]; }\r\n          }));\r\n          wrap.appendChild(buildCombo({\r\n            title: 'Site',\r\n            placeholder:'Search site',\r\n            getText:()=>state.clientSite.textSite||'',\r\n            setText:(v)=>{ state.clientSite.textSite=v||''; if(!(state.clientSite.selSite||[]).length){ renderBody(); updateCount(); } },\r\n            getCount:()=> (state.clientSite.selSite||[]).length,\r\n            open:(btn)=> togglePopoverDual('site', btn),\r\n            clear:()=>{ state.clientSite.textSite=''; state.clientSite.selSite=[]; }\r\n          }));\r\n        } else {\r\n          wrap.appendChild(buildCombo({\r\n            title: c.title,\r\n            placeholder:'Search',\r\n            getText:()=>state.columnText[c.id]||'',\r\n            setText:(v)=>{ state.columnText[c.id]=v||''; if(!(state.columnSelect[c.id]||[]).length){ renderBody(); updateCount(); } },\r\n            getCount:()=> (state.columnSelect[c.id]||[]).length,\r\n            open:(btn)=> togglePopover(c.id, btn),\r\n            clear:()=>{ state.columnText[c.id]=''; state.columnSelect[c.id]=[]; }\r\n          }));\r\n        }\r\n      }\r\n\r\n      th.appendChild(wrap);\r\n      trCols.appendChild(th);\r\n    });\r\n\r\n    headEl.appendChild(trSearch);\r\n    headEl.appendChild(trCols);\r\n  }\r\n\r\n  function buildCombo(opts){\r\n    var box=document.createElement('div'); box.className='combo';\r\n    var input=document.createElement('input');\r\n    input.className='combo-input';\r\n    input.placeholder=opts.placeholder||'Search';\r\n    input.value = opts.getText();\r\n\r\n    var right=document.createElement('div'); right.className='combo-right';\r\n    var badge=document.createElement('span');\r\n    badge.className='badge';\r\n    var count = opts.getCount();\r\n    badge.textContent = count > 0 ? String(count)+' selected' : 'Pick';\r\n    if(count === 0) badge.style.display = 'none';\r\n\r\n    var btn=document.createElement('button'); btn.type='button'; btn.className='combo-btn';\r\n    btn.setAttribute('aria-label','Pick values');\r\n    btn.innerHTML = '<svg class=\"chev\" viewBox=\"0 0 24 24\" aria-hidden=\"true\"><path d=\"M7 10l5 5 5-5z\"/></svg>';\r\n    btn.addEventListener('click', function(e){ e.stopPropagation(); opts.open(btn); });\r\n\r\n    var clearBtn = document.createElement('button');\r\n    clearBtn.className = 'clear-filter-btn';\r\n    clearBtn.innerHTML = '&times;';\r\n    clearBtn.setAttribute('aria-label', 'Clear filter for ' + opts.title);\r\n\r\n    var toggleClearBtn = function() {\r\n      var hasText = input.value.trim() !== '';\r\n      var hasSelection = opts.getCount() > 0;\r\n      clearBtn.style.display = (hasText || hasSelection) ? 'flex' : 'none';\r\n    };\r\n\r\n    clearBtn.addEventListener('click', function() {\r\n      input.value = '';\r\n      opts.clear();\r\n      box._updateBadge(0);\r\n      renderBody();\r\n      updateCount();\r\n    });\r\n\r\n    input.addEventListener('input', debounce(function(e){\r\n      opts.setText(e.target.value||'');\r\n      toggleClearBtn();\r\n    }, 120));\r\n\r\n    box._updateBadge = function(n){\r\n      if(n>0){ badge.style.display='inline-block'; badge.textContent = n+' selected'; }\r\n      else { badge.style.display='none'; }\r\n      toggleClearBtn();\r\n    };\r\n\r\n    right.appendChild(badge);\r\n    right.appendChild(btn);\r\n    box.appendChild(input);\r\n    box.appendChild(clearBtn);\r\n    box.appendChild(right);\r\n    toggleClearBtn();\r\n    return box;\r\n  }\r\n\r\n  function placePopoverUnder(anchorBtn, pop){\r\n    var rect = anchorBtn.getBoundingClientRect();\r\n    var left = rect.left;\r\n    var top  = rect.bottom + 6;\r\n\r\n    document.body.appendChild(pop);\r\n    var pw = pop.offsetWidth, ph = pop.offsetHeight;\r\n\r\n    if (left + pw > window.innerWidth - 8) left = Math.max(8, window.innerWidth - pw - 8);\r\n    if (top  + ph > window.innerHeight - 8) {\r\n      var altTop = rect.top - ph - 6;\r\n      top = (altTop >= 8) ? altTop : Math.max(8, window.innerHeight - ph - 8);\r\n    }\r\n\r\n    pop.style.left = left + 'px';\r\n    pop.style.top  = top  + 'px';\r\n  }\r\n\r\n  function togglePopoverDual(kind, anchorBtn){\r\n    closePopover();\r\n    anchorBtn.classList.add('active');\r\n\r\n    var pop=document.createElement('div'); pop.className='popover';\r\n    var list=document.createElement('div'); pop.appendChild(list);\r\n    var baseRows=filteredRowsExcluding('clientSiteHTML', kind);\r\n\r\n    function renderList(){\r\n      list.innerHTML='';\r\n      var items=uniqueValuesByKey(kind==='client'?'clientRaw':'site', baseRows);\r\n      var selArr = (kind==='client' ? (state.clientSite.selClient||[]) : (state.clientSite.selSite||[]));\r\n\r\n      items.forEach(function(it){\r\n        var row=document.createElement('div'); row.className='opt';\r\n        var cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.v; cb.checked = selArr.indexOf(it.v)>-1;\r\n        var lab=document.createElement('label'); lab.textContent=it.v+' ('+it.c+')';\r\n\r\n        cb.addEventListener('change', function(e){\r\n          var arr = (kind==='client' ? state.clientSite.selClient : state.clientSite.selSite);\r\n          var v = e.target.value;\r\n          if(e.target.checked){ if(arr.indexOf(v)===-1) arr.push(v); }\r\n          else { var idx=arr.indexOf(v); if(idx>-1) arr.splice(idx,1); }\r\n\r\n          renderBody(); updateCount();\r\n          var combo = anchorBtn.closest('.combo');\r\n          if (combo && combo._updateBadge) combo._updateBadge(arr.length);\r\n        });\r\n\r\n        row.appendChild(cb); row.appendChild(lab); list.appendChild(row);\r\n      });\r\n    }\r\n    renderList();\r\n\r\n    placePopoverUnder(anchorBtn, pop);\r\n\r\n    function closeOnOutside(e){ if(!pop.contains(e.target) && e.target!==anchorBtn){ closePopover(); } }\r\n    document.addEventListener('mousedown', closeOnOutside);\r\n    pop._closeHandler=closeOnOutside; pop._anchor=anchorBtn; state._popoverEl=pop;\r\n  }\r\n\r\n  function togglePopover(colId, anchorBtn){\r\n    closePopover();\r\n    anchorBtn.classList.add('active');\r\n\r\n    var pop=document.createElement('div'); pop.className='popover';\r\n    var list=document.createElement('div'); pop.appendChild(list);\r\n    var baseRows=filteredRowsExcluding(colId);\r\n\r\n    function renderList(){\r\n      list.innerHTML='';\r\n      var items=uniqueValues(colId, baseRows);\r\n      var selArr=(state.columnSelect[colId]||[]);\r\n\r\n      items.forEach(function(it){\r\n        var row=document.createElement('div'); row.className='opt';\r\n        var cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.v; cb.checked = selArr.indexOf(it.v)>-1;\r\n        var lab=document.createElement('label'); lab.textContent=it.v+' ('+it.c+')';\r\n\r\n        cb.addEventListener('change', function(e){\r\n          var cur = state.columnSelect[colId] || [];\r\n          var v = e.target.value;\r\n          if(e.target.checked){ if(cur.indexOf(v)===-1) cur.push(v); }\r\n          else { var idx=cur.indexOf(v); if(idx>-1) cur.splice(idx,1); }\r\n          state.columnSelect[colId] = cur;\r\n\r\n          renderBody(); updateCount();\r\n          var combo = anchorBtn.closest('.combo');\r\n          if (combo && combo._updateBadge) combo._updateBadge(cur.length);\r\n        });\r\n\r\n        row.appendChild(cb); row.appendChild(lab); list.appendChild(row);\r\n      });\r\n    }\r\n    renderList();\r\n\r\n    placePopoverUnder(anchorBtn, pop);\r\n\r\n    function closeOnOutside(e){ if(!pop.contains(e.target) && e.target!==anchorBtn){ closePopover(); } }\r\n    document.addEventListener('mousedown', closeOnOutside);\r\n    pop._closeHandler=closeOnOutside; pop._anchor=anchorBtn; state._popoverEl=pop;\r\n  }\r\n\r\n  function closePopover(){\r\n    var pop=state._popoverEl;\r\n    if(pop){\r\n      document.removeEventListener('mousedown', pop._closeHandler||function(){});\r\n      if(pop._anchor) pop._anchor.classList.remove('active');\r\n      pop.remove();\r\n      state._popoverEl=null;\r\n    }\r\n  }\r\n\r\n  function renderBody(){\r\n    bodyEl.innerHTML='';\r\n    var rows=getFilteredSortedData();\r\n    for(var i=0;i<rows.length;i++){\r\n      var r=rows[i];\r\n      var tr=document.createElement('tr');\r\n      for(var c=0;c<columns.length;c++){\r\n        var col=columns[c];\r\n        var td=document.createElement('td');\r\n        var val=r[col.id];\r\n        if(col.html){ td.appendChild(htmlNode(val)); } else { td.textContent=val!=null?val:''; }\r\n        tr.appendChild(td);\r\n      }\r\n      bodyEl.appendChild(tr);\r\n    }\r\n  }\r\n\r\n  function updateCount(){\r\n    document.getElementById('visibleCount').textContent=String(getFilteredSortedData().length);\r\n  }\r\n\r\n  /* Build & render */\r\n  buildHeader();\r\n  renderBody();\r\n  updateCount();\r\n\r\n  document.getElementById('loading').style.display='none';\r\n  document.getElementById('tableWrap').style.display='block';\r\n</script>\r\n\r\n{% endblock %}",
    "type": "html",
    "depends_on": [],
    "template_variables": "data_sources:\r\n  agentsList:\r\n    model: agent\r\n    custom_fields:\r\n      - WarrantyExpiration\r\n      - BatteryHealthPercentage\r\n    only:\r\n      - hostname\r\n      - operating_system\r\n      - site__name\r\n      - site__client__name\r\n      - last_logged_in_user\r\n      - wmi_detail\r\n      - total_ram\r\nreport_run_timestamp: !now"
  },
  "assets": []
}