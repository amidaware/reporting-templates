{
  "base_template": {
    "name": "TRMM_Base v1.1",
    "html": "<html>\n\n<head>\n    <style>\n        /* —— PDF page settings —— */\n        @page {\n            margin: 0.5in;\n            size: letter portrait;\n        }\n\n        /* —— Color palette (theme) —— */\n        :root {\n            --header-bg: #2c3e50;\n            --header-text: #ffffff;\n            --border-color: #dddddd;\n            --table-header-bg: #f2f2f2;\n            --status-ready-bg: #eaf7ec;\n            --status-ready-badge: #28a745;\n            --status-not-ready-bg: #fbebee;\n            --status-not-ready-badge: #dc3545;\n            --status-unknown-bg: #fff9e6;\n            --status-unknown-badge: #ffc107;\n            --badge-already-bg: #17a2b8;\n        }\n\n        /* —— Typography & utilities (structure) —— */\n        body {\n            font-family: sans-serif;\n            color: #333;\n            font-size: 12px;\n        }\n\n        .section {\n            margin-top: 20px;\n        }\n\n        .text-danger {\n            color: #a94442;\n            font-weight: bold;\n        }\n\n        /* —— Header layout (structure) —— */\n        .report-header {\n            background-color: var(--header-bg);\n            color: var(--header-text);\n            padding: 20px;\n            border-radius: 8px;\n            display: flex;\n            align-items: center;\n        }\n\n        .header-logo {\n            width: 80px;\n            margin-right: 25px;\n            flex-shrink: 0;\n        }\n\n        .header-date {\n            margin-left: auto;\n            text-align: right;\n            white-space: nowrap;\n        }\n\n        .report-header h1 {\n            font-size: 24px;\n            margin: 0 0 5px;\n        }\n\n        .report-header h2 {\n            font-size: 16px;\n            margin: 0;\n            opacity: 0.9;\n        }\n\n        /* —— Standardized Table Styles (structure) —— */\n        .report-table {\n            border-collapse: collapse;\n            width: 100%;\n        }\n\n        .report-table th,\n        .report-table td {\n            border: 1px solid var(--border-color);\n            padding: 6px 8px;\n            text-align: left;\n            vertical-align: top;\n        }\n\n        .report-table thead th {\n            background-color: var(--table-header-bg);\n            font-weight: bold;\n            cursor: pointer;\n            user-select: none;\n        }\n\n        /* Header label + sort indicators */\n        .th-topline {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            gap: .4rem;\n        }\n\n        .th-label {\n            position: relative;\n            cursor: pointer;\n            user-select: none;\n        }\n\n        /* These are the specific rules that make the indicator visible */\n        th.sorted.asc .th-label::after {\n            content: \"▲\";\n            padding-left: .4rem;\n            color: #333;\n            font-size: .9em;\n        }\n\n        th.sorted.desc .th-label::after {\n            content: \"▼\";\n            padding-left: .4rem;\n            color: #333;\n            font-size: .9em;\n        }\n\n        .report-table thead th select {\n            width: 100%;\n            margin-top: 5px;\n            padding: 4px;\n            border-radius: 4px;\n            border: 1px solid #ccc;\n            font-weight: normal;\n            background: #fff;\n        }\n\n        /* —— Badge shape (structure) —— */\n        .status-badge {\n            display: inline-block;\n            padding: 4px 10px;\n            border-radius: 12px;\n            color: #fff;\n            font-weight: bold;\n            font-size: 11px;\n            text-align: center;\n            white-space: nowrap;\n        }\n\n        /* —— Stub classes for per‑report overrides —— */\n        .status-ready {}\n\n        .status-not-ready {}\n\n        .status-unknown {}\n\n        .badge-ready {}\n\n        .badge-not-ready {}\n\n        .badge-unknown {}\n\n        .badge-already {}\n    </style>\n</head>\n\n<body>\n    {% block content %}{% endblock %}\n</body>\n\n</html>"
  },
  "template": {
    "name": "Comprehensive Report_by Client (html) v1.12",
    "template_css": ".content-wrapper {\r\n        margin-left: 20px;  /* Adjust the margin as needed */\r\n        margin-right: 20px; /* Adjust the margin as needed */\r\n    }\r\ntable {\r\n    width: 100%;\r\n    border-collapse: collapse;\r\n}\r\nth, td {\r\n    border: 1px solid #ddd;\r\n    padding: 8px;\r\n}\r\nth {\r\n    background-color: #f2f2f2;\r\n    text-align: left;\r\n}\r\ntr:nth-child(even){background-color: #f2f2f2}\r\n/* This is the default state where full headers are visible */\r\n.full-header .short-header {\r\n    display: none;\r\n}\r\n\r\n/* Media query for mobile screens */\r\n@media screen and (max-width: 768px) {\r\n    .full-header .short-header {\r\n        display: inline-block; /* Show abbreviated headers */\r\n    }\r\n    .full-header {\r\n        display: none; /* Hide full headers */\r\n    }\r\n}",
    "template_md": "{% block content %}\r\n\r\n{% set totals = {'workstation': 0, 'server': 0, 'mac': 0, 'linux': 0} %}\r\n{% for agent in data_sources.agentsList %}\r\n  {% if agent.plat == 'windows' %}\r\n    {% if 'server' in agent.operating_system|lower %}\r\n      {% set _ = totals.update({'server': totals.server + 1}) %}\r\n    {% else %}\r\n      {% set _ = totals.update({'workstation': totals.workstation + 1}) %}\r\n    {% endif %}\r\n  {% elif agent.plat == 'darwin' %}\r\n    {% set _ = totals.update({'mac': totals.mac + 1}) %}\r\n  {% elif agent.plat == 'linux' %}\r\n    {% set _ = totals.update({'linux': totals.linux + 1}) %}\r\n  {% endif %}\r\n{% endfor %}\r\n{% set total_stations = data_sources.agentsList | length %}\r\n\r\n{% set categories = [\r\n  {'name': 'Workstation', 'count': totals.workstation, 'color': '#c94a0a'},\r\n  {'name': 'Mac', 'count': totals.mac, 'color': '#007bff'},\r\n  {'name': 'Windows server','count': totals.server,'color': '#ffc107'},\r\n  {'name': 'Linux', 'count': totals.linux, 'color': '#dc3545'}\r\n] %}\r\n\r\n{% set gradient_parts = [] %}\r\n{% set running_total = 0 %}\r\n{% set largest_category = {'name': '', 'percent': 0} %}\r\n{% for cat in categories %}\r\n  {% if total_stations > 0 %}\r\n    {% set percent = (cat.count / total_stations) * 100 %}\r\n    {% if percent > largest_category.percent %}\r\n      {% set _ = largest_category.update({'name': cat.name, 'percent': percent | round(0) | int}) %}\r\n    {% endif %}\r\n    {% if percent > 0 %}\r\n      {% do gradient_parts.append(cat.color ~ ' ' ~ running_total ~ '% ' ~ (running_total + percent) ~ '%') %}\r\n      {% set running_total = running_total + percent %}\r\n    {% endif %}\r\n  {% endif %}\r\n{% endfor %}\r\n\r\n{% set office_stop_words = ['update','service pack','mui','component','proof','access','excel','powerpoint','publisher','outlook','onenote','infopath','lync','skype','viewer','shared'] %}\r\n{% set office_counts = {} %}\r\n{% set office_total = 0 %}\r\n{% for agent_sw in data_sources.softwareList %}\r\n  {% for sw in agent_sw.software %}\r\n    {% if 'microsoft office' in sw.name|lower or 'office 365' in sw.name|lower %}\r\n      {% set is_major_version = [true] %}\r\n      {% for stop_word in office_stop_words %}\r\n        {% if stop_word in sw.name|lower %}\r\n          {% if is_major_version.pop() %}{% do is_major_version.append(false) %}{% endif %}\r\n        {% endif %}\r\n      {% endfor %}\r\n      {% if is_major_version[0] %}\r\n        {% set _ = office_counts.update({sw.name: office_counts.get(sw.name, 0) + 1}) %}\r\n      {% endif %}\r\n    {% endif %}\r\n  {% endfor %}\r\n{% endfor %}\r\n\r\n{% set os_counts = {} %}\r\n{% for agent in data_sources.agentsList %}\r\n  {% set _ = os_counts.update({agent.operating_system: os_counts.get(agent.operating_system, 0) + 1}) %}\r\n{% endfor %}\r\n\r\n{% set office_total = office_counts.values() | sum %} \r\n\r\n<style>\r\n/* Styling for main section H2s */\r\n.section-header {\r\n    background-color: #004085; /* Darker blue background */\r\n    color: #FFFFFF !important; /* White text */\r\n    font-size: 1.8em; /* Bigger font */\r\n    font-variant: small-caps;\r\n    padding: 12px 15px;\r\n    margin-top: 30px;\r\n    margin-bottom: 20px;\r\n    border-radius: 6px;\r\n    letter-spacing: 1px;\r\n    font-weight: bold;\r\n    display: flex; /* For vertical centering */\r\n    align-items: center; /* For vertical centering */\r\n    justify-content: center; /* For horizontal centering */\r\n}\r\n\r\n/* Table headers styling (lighter blue background, darker blue text for visibility) */\r\n.disk-report-table th,\r\n.agent-details-table th,\r\n.agent-tasks-table th,\r\n.agent-checks-table th,\r\n.agent-sw-table th,\r\n.agent-patch-table th {\r\n    background-color: #ADD8E6 !important; /* Lighter blue */\r\n    color: #004085 !important; /* Darker blue for text */\r\n    text-align: left;\r\n    padding: 8px;\r\n    font-weight: bold;\r\n}\r\n\r\n/* Navigation bar style */\r\n.navbar {\r\n    list-style: none;\r\n    padding: 0;\r\n    margin: 20px 0;\r\n    display: flex;\r\n    justify-content: center; /* Center the navigation items */\r\n    gap: 15px; /* Space between items */\r\n    background-color: #E9ECEF; /* A very light grey background for the nav bar */\r\n    padding: 10px 20px;\r\n    border-radius: 8px;\r\n    box-shadow: 0 2px 4px rgba(0,0,0,0.1);\r\n    flex-wrap: wrap; /* Allow items to wrap on smaller screens */\r\n}\r\n\r\n.navbar li a {\r\n    text-decoration: none;\r\n    cursor: pointer;\r\n    color: #004085; /* Dark blue text for links */\r\n    font-weight: bold;\r\n    padding: 8px 15px;\r\n    border-radius: 5px;\r\n    transition: background-color 0.3s ease;\r\n    font-size: 0.95em;\r\n    white-space: nowrap; /* Prevent items from wrapping */\r\n}\r\n\r\n.navbar li a:hover {\r\n    background-color: #D4D4D4; /* Lighter hover effect */\r\n    color: #002D62; /* Even darker blue on hover */\r\n}\r\n\r\n/* General styles */\r\n.inventory-box {border:1px solid #e0e0e0;background-color:#f9f9f9;border-radius:8px;padding:20px;display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}\r\n.inventory-list {flex:1;}\r\n.list-item {display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #eee;font-size:14px;}\r\n.list-item:last-child {border-bottom:none;}\r\n.list-item-label {display:flex;align-items:center;}\r\n.color-dot {width:12px;height:12px;border-radius:50%;margin-right:10px;flex-shrink:0;}\r\n.count-badge {background-color:#777;color:white;padding:3px 8px;border-radius:10px;font-size:12px;font-weight:bold;}\r\n.inventory-chart {flex-basis:200px;display:flex;justify-content:center;align-items:center;}\r\n.chart-circle {width:150px;height:150px;border-radius:50%;background-image:conic-gradient({{ gradient_parts | join(', ') }});display:flex;justify-content:center;align-items:center;position:relative;}\r\n.chart-inner-circle {width:110px;height:110px;background-color:#f9f9f9;border-radius:50%;display:flex;justify-content:center;align-items:center;flex-direction:column;text-align:center;}\r\n.chart-inner-circle strong {font-size:16px;font-weight:bold;color:#333;}\r\n.sw-inventory-table {width:100%;border-collapse:collapse;font-size:14px;}\r\n.sw-inventory-table td {padding:15px 0;vertical-align:top;border-bottom:1px solid #e0e0e0;}\r\n.sw-inventory-table tr:last-child td {border-bottom:none;}\r\n.sw-category-cell {width:25%;font-weight:bold;}\r\n.sw-details-cell {padding-left:20px;}\r\n.sw-item {display:flex;justify-content:space-between;padding:5px 0;}\r\n.sw-item-name {flex:1;padding-right:15px;}\r\n.sw-item-count {font-weight:bold;}\r\n.disk-usage-section {margin-bottom:25px;}\r\n.disk-filter-bar {margin-bottom:15px;font-size:14px;color:#555;}\r\n.disk-filter-bar select {border:1px solid #ccc;border-radius:4px;padding:4px;font-family:sans-serif;}\r\n.disk-report-table {width:100%;border-collapse:collapse;font-size:14px;}\r\n.disk-report-table td {text-align:left;padding:12px 8px;border-bottom:1px solid #eee;}\r\n.disk-report-table tr:last-child td {border-bottom:none;}\r\n.disk-progress-container {width:150px;height:20px;background-color:#e9ecef;border-radius:4px;overflow:hidden;position:relative;}\r\n.disk-progress-bar {height:100%;background-color:#dc3545;}\r\n@media print {table{page-break-inside:auto;}.table-container,.table-half{display:block;width:100%;}tr{page-break-inside:avoid;page-break-after:auto;}td,th{page-break-inside:avoid;}}\r\n.header-container {display:flex;justify-content:space-between;align-items:center;padding-bottom:10px;border-bottom:2px solid black;margin-bottom:10px;}\r\n.section {width:100%;padding-bottom:20px;}\r\n.table-container {display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}\r\n.table-half {width:49%;}\r\n.agent-disk-progress-bar {width:100%;height:18px;background-color:#e9ecef;border-radius:10px;overflow:hidden;position:relative;margin-top:4px;margin-bottom:4px;}\r\n.agent-disk-progress-fill {height:100%;border-radius:10px;}\r\n.progress-text { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: #000; text-shadow: 0 0 2px #fff, 0 0 4px #fff, 0 0 6px #fff; pointer-events: none; }\r\n.agent-tasks-table, .agent-checks-table, .agent-sw-table, .agent-patch-table {width:100%;border-collapse:collapse;font-size:11px;}\r\n.agent-tasks-table td, .agent-checks-table td, .agent-sw-table td, .agent-patch-table td {border:1px solid black;padding:5px;text-align:left;vertical-align:top;}\r\nh3,h4 {margin-top:10px;margin-bottom:5px;}\r\n\r\n/* Mac distribution specific styles */\r\n.mac-header-bar { display: flex; justify-content: space-between; align-items: center; margin: 10px 0 15px 0; }\r\n.mac-header-bar .description { margin: 0; font-size: 14px; color: #555; text-align: left; }\r\n.mac-header-bar .counter { font-size: 14px; font-weight: bold; color: #333; }\r\n.mac-table {width:100%;border-collapse:collapse;font-size:14px; border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden; }\r\n.mac-table th {background-color:#ADD8E6 !important; color:#004085 !important; text-align:left;padding:8px;font-weight:bold;}\r\n.mac-table td {padding:10px 8px;border-bottom:1px solid #eee;}\r\n.mac-table tr:last-child td { border-bottom: none; }\r\n.mac-table thead .filter-row { background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; }\r\n.mac-table thead .filter-row td { padding: 8px; vertical-align: middle; text-align: left; }\r\n.mac-table thead .filter-row select { width: 95%; max-width: 250px; border:1px solid #ccc; border-radius:4px; padding:4px; font-family:sans-serif; }\r\n\r\n/* Workstation distribution specific styles */\r\n.workstation-table { width: 100%; border-collapse: collapse; font-size: 14px; border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden; }\r\n.workstation-table th { background-color:#ADD8E6 !important; color:#004085 !important; text-align:left; padding:8px; font-weight:bold; }\r\n.workstation-table td { padding:10px 8px; border-bottom:1px solid #eee; }\r\n.workstation-table tr:last-child td { border-bottom: none; }\r\n.workstation-table thead .filter-row { background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; }\r\n.workstation-table thead .filter-row td { padding: 8px; vertical-align: middle; text-align: left; }\r\n.workstation-table thead .filter-row td:first-child { text-align: left; font-weight: bold; }\r\n.workstation-table thead .filter-row select { width: 95%; max-width: 150px; border:1px solid #ccc; border-radius:4px; padding:4px; }\r\n.dot {width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:8px;vertical-align: middle;}\r\n.dot.crit {background:#dc3545;}\r\n.dot.warn {background:#ffc107;}\r\n.cell-crit { background-color:#f8d7da !important; }\r\n.cell-warn { background-color:#fff3cd !important; }\r\n\r\n/* Server distribution specific styles */\r\n.server-table { width: 100%; border-collapse: collapse; font-size: 14px; border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden; }\r\n.server-table th { background-color:#ADD8E6 !important; color:#004085 !important; text-align:left; padding:8px; font-weight:bold; }\r\n.server-table td { padding:10px 8px; border-bottom:1px solid #eee; }\r\n.server-table tr:last-child td { border-bottom: none; }\r\n.server-table thead .filter-row { background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; }\r\n.server-table thead .filter-row td { padding: 8px; vertical-align: middle; text-align: left; }\r\n.server-table thead .filter-row td:first-child { text-align: left; font-weight: bold; }\r\n.server-table thead .filter-row select { width: 95%; max-width: 150px; border:1px solid #ccc; border-radius:4px; padding:4px; }\r\n\r\n/* Individual Machine List NEW styles */\r\n.agent-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }\r\n.agent-header-title { font-size: 1.6em; font-weight: bold; display: flex; align-items: center; flex-shrink: 0; padding-right: 30px; }\r\n.agent-header-details table { font-size: 13px; }\r\n.agent-header-details td { padding: 2px 5px; }\r\n.agent-header-details td:first-child { font-weight: bold; text-align: right; }\r\n.agent-simple-summary { font-size: 13px; line-height: 1.6; margin-bottom: 20px; }\r\n.agent-simple-summary h4 { font-size: 1.1em; font-weight: bold; margin-top: 15px; margin-bottom: 5px; }\r\n.agent-simple-summary table { border-collapse: collapse; width: 100%; margin-bottom: 15px; }\r\n.agent-simple-summary td { padding: 1px 5px; vertical-align: top; }\r\n.agent-simple-summary .key { font-weight: bold; width: 140px; }\r\n\r\n</style>\r\n\r\n<div class=\"report-header\">\r\n  <div class=\"header-logo\">\r\n    <img src=\"https://github.com/amidaware/reporting-templates/blob/master/assets/gbtnavy%20(256).png?raw=true\" alt=\"Amidaware Logo\" style=\"width: 80px; height: auto;\">\r\n  </div>\r\n  <div>\r\n    <h1>Comprehensive System Health Report</h1>\r\n    <h2>Client: {{ client.name }}</h2>\r\n  </div>\r\n  <div class=\"header-date\">\r\n    <h2>Report Date:<br>{{ report_run_timestamp.strftime('%B %d, %Y') }}</h2>\r\n  </div>\r\n</div>\r\n\r\n<ul class=\"navbar\">\r\n    <li><a data-target=\"general-inventory\">General Inventory</a></li>\r\n    <li><a data-target=\"software-inventory\">Software Inventory</a></li>\r\n    <li><a data-target=\"disk-usage-audit\">Disk Usage Audit</a></li>\r\n    <li><a data-target=\"server-distribution\">Server Distribution</a></li>\r\n    <li><a data-target=\"workstation-distribution\">Workstation Distribution</a></li>\r\n    <li><a data-target=\"mac-distribution\">Mac Distribution</a></li>\r\n    <li><a data-target=\"individual-machine-list\">Individual Machine List</a></li>\r\n</ul>\r\n\r\n<div id=\"general-inventory\" class=\"inventory-section\">\r\n  <h2 class=\"section-header\">General Inventory</h2>\r\n  <div class=\"inventory-box\">\r\n    <div class=\"inventory-list\">\r\n      <div class=\"list-item\" style=\"font-weight:bold;\">\r\n        <div class=\"list-item-label\">Total Stations</div>\r\n        <div class=\"count-badge\">{{ total_stations }}</div>\r\n      </div>\r\n      {% for cat in categories %}\r\n      <div class=\"list-item\">\r\n        <div class=\"list-item-label\">\r\n          <div class=\"color-dot\" style=\"background-color: {{ cat.color }};\"></div>\r\n          {{ cat.name }}\r\n        </div>\r\n        <div class=\"count-badge\">{{ cat.count }}</div>\r\n      </div>\r\n      {% endfor %}\r\n    </div>\r\n    <div class=\"inventory-chart\">\r\n      <div class=\"chart-circle\">\r\n        <div class=\"chart-inner-circle\">\r\n          <strong>{{ largest_category.name }}</strong>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</div>\r\n\r\n<div id=\"software-inventory\" class=\"sw-inventory-section\">\r\n  <h2 class=\"section-header\">Software Inventory</h2>\r\n  <table class=\"sw-inventory-table\">\r\n    <tr>\r\n      <td class=\"sw-category-cell\">Office ({{ office_total }})</td>\r\n      <td class=\"sw-details-cell\">\r\n        {% for name, count in office_counts|dictsort %}\r\n        <div class=\"sw-item\">\r\n          <span class=\"sw-item-name\">{{ name }}</span>\r\n          <span class=\"sw-item-count\">{{ count }}</span>\r\n        </div>\r\n        {% else %}\r\n        <div class=\"sw-item\"><span>No major Office versions found.</span></div>\r\n        {% endfor %}\r\n      </td>\r\n    </tr>\r\n    <tr>\r\n      <td class=\"sw-category-cell\">OS Edition ({{ total_stations }})</td>\r\n      <td class=\"sw-details-cell\">\r\n        {% for name, count in os_counts|dictsort %}\r\n        <div class=\"sw-item\">\r\n          <span class=\"sw-item-name\">{{ name }}</span>\r\n          <span class=\"sw-item-count\">{{ count }}</span>\r\n        </div>\r\n        {% endfor %}\r\n      </td>\r\n    </tr>\r\n  </table>\r\n</div>\r\n\r\n<div id=\"disk-usage-audit\" class=\"disk-usage-section\">\r\n  <h2 class=\"section-header\">Disk Usage Audit</h2>\r\n  <div class=\"disk-filter-bar\">\r\n    Display all disks that have less than \r\n    <select id=\"disk-threshold-select\">\r\n      <option value=\"50\">50%</option>\r\n      <option value=\"25\">25%</option>\r\n      <option value=\"10\" selected>10%</option>\r\n      <option value=\"5\">5%</option>\r\n    </select>\r\n  </div>\r\n  <table class=\"disk-report-table\" id=\"disk-report-table\">\r\n    <thead>\r\n      <tr><th>Computer Name</th><th>Drive</th><th>Used / Total</th><th>Usage</th></tr>\r\n    </thead>\r\n    <tbody id=\"disk-report-body\">\r\n      {% set any_disks = false %}\r\n      {% for agent in data_sources.agentsList %}\r\n        {% for disk in agent.disks %}\r\n          {% set used_pct_raw = (disk.percent or 0) | float %}\r\n          {% set used_pct = 0 if used_pct_raw < 0 else 100 if used_pct_raw > 100 else used_pct_raw %}\r\n          {% set free_pct = 100 - used_pct %}\r\n          {% set any_disks = true %}\r\n          <tr class=\"disk-row\" data-freepct=\"{{ free_pct | round(0) }}\">\r\n            <td>{{ agent.hostname }}</td>\r\n            <td>{{ disk.device }}</td>\r\n            <td>{{ disk.used }} / {{ disk.total }}</td>\r\n            <td>\r\n              <div class=\"disk-progress-container\">\r\n                <div class=\"disk-progress-bar\" style=\"width: {{ used_pct }}%;\"></div>\r\n                <div class=\"progress-text\">{{ free_pct | round(0) }}% free</div>\r\n              </div>\r\n            </td>\r\n          </tr>\r\n        {% endfor %}\r\n      {% endfor %}\r\n      {% if not any_disks %}\r\n      <tr><td colspan=\"4\" style=\"text-align:center;padding:20px;color:#555;\">No disks found.</td></tr>\r\n      {% endif %}\r\n    </tbody>\r\n  </table>\r\n  <div id=\"no-matches-row\" style=\"display:none;text-align:center;padding:20px;color:#555;\">No disks matching the criteria were found.</div>\r\n</div>\r\n\r\n<div id=\"server-distribution\" class=\"server-distribution-section\">\r\n  <h2 class=\"section-header\">Server Distribution</h2>\r\n\r\n  {% set servers = [] %}\r\n  {% set srv_os, srv_cores, srv_clock, srv_mem = {}, {}, {}, {} %}\r\n  {% for agent in data_sources.agentsList if agent.plat == 'windows' and 'server' in agent.operating_system|lower %}\r\n    {% set _ = servers.append(agent) %}\r\n    {% set _ = srv_os.update({(agent.operating_system or 'N/A'): true}) %}\r\n    {% set cores = (agent.wmi_detail.cpu[0][0].NumberOfCores or 0) if agent.wmi_detail and agent.wmi_detail.cpu else 0 %}\r\n    {% if cores > 0 %}{% set _ = srv_cores.update({cores: true}) %}{% endif %}\r\n    {% set mhz = (agent.wmi_detail.cpu[0][0].MaxClockSpeed or 0) if agent.wmi_detail and agent.wmi_detail.cpu else 0 %}\r\n    {% if mhz > 0 %}{% set _ = srv_clock.update({(mhz/1000.0)|round(2): true}) %}{% endif %}\r\n    {% set mem_gb = agent.total_ram or 0 %}\r\n    {% if mem_gb > 0 %}{% set _ = srv_mem.update({(mem_gb*1024)|int: true}) %}{% endif %}\r\n  {% endfor %}\r\n\r\n  <table class=\"server-table\">\r\n    <thead>\r\n      <tr class=\"filter-row\">\r\n        <td><span class=\"dot warn\"></span>Attention</td>\r\n        <td><select id=\"srv-warn-os\"><option value=\"\">Any</option>{% for i in srv_os.keys()|sort %}<option value=\"{{i}}\">{{i}}</option>{% endfor %}</select></td>\r\n        <td><select id=\"srv-warn-cores\"><option value=\"\">Any</option>{% for i in srv_cores.keys()|sort|reverse %}<option value=\"{{i}}\">{{i}}</option>{% endfor %}</select></td>\r\n        <td><select id=\"srv-warn-clock\"><option value=\"\">Any</option>{% for i in srv_clock.keys()|sort|reverse %}<option value=\"{{i}}\">{{'%.2f'|format(i)}} Ghz</option>{% endfor %}</select></td>\r\n        <td><select id=\"srv-warn-mem\"><option value=\"\">Any</option>{% for i in srv_mem.keys()|sort|reverse %}<option value=\"{{i}}\">{{(i//1024)|string~' GB' if i>=1024 else i|string~' MB'}}</option>{% endfor %}</select></td>\r\n      </tr>\r\n      <tr class=\"filter-row\">\r\n        <td><span class=\"dot crit\"></span>Critical</td>\r\n        <td><select id=\"srv-crit-os\"><option value=\"\">Any</option>{% for i in srv_os.keys()|sort %}<option value=\"{{i}}\">{{i}}</option>{% endfor %}</select></td>\r\n        <td><select id=\"srv-crit-cores\"><option value=\"\">Any</option>{% for i in srv_cores.keys()|sort|reverse %}<option value=\"{{i}}\">{{i}}</option>{% endfor %}</select></td>\r\n        <td><select id=\"srv-crit-clock\"><option value=\"\">Any</option>{% for i in srv_clock.keys()|sort|reverse %}<option value=\"{{i}}\">{{'%.2f'|format(i)}} Ghz</option>{% endfor %}</select></td>\r\n        <td><select id=\"srv-crit-mem\"><option value=\"\">Any</option>{% for i in srv_mem.keys()|sort|reverse %}<option value=\"{{i}}\">{{(i//1024)|string~' GB' if i>=1024 else i|string~' MB'}}</option>{% endfor %}</select></td>\r\n      </tr>\r\n      <tr>\r\n        <th>Agent Name</th>\r\n        <th>OS</th>\r\n        <th>Cores</th>\r\n        <th>CPU Clock</th>\r\n        <th>Memory</th>\r\n      </tr>\r\n    </thead>\r\n    <tbody>\r\n      {% for agent in servers %}\r\n        {% set os = agent.operating_system or 'N/A' %}\r\n        {% set cores = (agent.wmi_detail.cpu[0][0].NumberOfCores or 0) if agent.wmi_detail and agent.wmi_detail.cpu else 0 %}\r\n        {% set mhz = (agent.wmi_detail.cpu[0][0].MaxClockSpeed or 0) if agent.wmi_detail and agent.wmi_detail.cpu else 0 %}\r\n        {% set clock = (mhz/1000.0)|round(2) %}\r\n        {% set mem_gb = agent.total_ram or 0 %}\r\n        {% set mem_mb = (mem_gb * 1024)|int %}\r\n        <tr class=\"srv-row\" \r\n            data-os=\"{{os}}\" data-cores=\"{{cores}}\" \r\n            data-clock=\"{{clock}}\" data-mem=\"{{mem_mb}}\">\r\n          <td>{{ agent.hostname }}</td>\r\n          <td class=\"cell-os\">{{ os }}</td>\r\n          <td class=\"cell-cores\">{{ cores if cores > 0 else 'N/A' }}</td>\r\n          <td class=\"cell-clock\">{{ '%.2f Ghz'|format(clock) if clock > 0 else 'N/A' }}</td>\r\n          <td class=\"cell-mem\">{{ mem_gb|string ~ ' GB' if mem_gb > 0 else 'N/A' }}</td>\r\n        </tr>\r\n      {% else %}\r\n        <tr><td colspan=\"5\" style=\"text-align:center;padding:18px;color:#555;\">No Windows servers found.</td></tr>\r\n      {% endfor %}\r\n    </tbody>\r\n  </table>\r\n</div>\r\n\r\n<div id=\"workstation-distribution\" class=\"workstation-distribution-section\">\r\n  <h2 class=\"section-header\">Workstation Distribution</h2>\r\n\r\n  {% set workstations = [] %}\r\n  {% set ws_os, ws_cores, ws_clock, ws_mem = {}, {}, {}, {} %}\r\n  {% for agent in data_sources.agentsList if agent.plat == 'windows' and 'server' not in agent.operating_system|lower %}\r\n    {% set _ = workstations.append(agent) %}\r\n    {% set _ = ws_os.update({(agent.operating_system or 'N/A'): true}) %}\r\n    {% set cores = (agent.wmi_detail.cpu[0][0].NumberOfCores or 0) if agent.wmi_detail and agent.wmi_detail.cpu else 0 %}\r\n    {% if cores > 0 %}{% set _ = ws_cores.update({cores: true}) %}{% endif %}\r\n    {% set mhz = (agent.wmi_detail.cpu[0][0].MaxClockSpeed or 0) if agent.wmi_detail and agent.wmi_detail.cpu else 0 %}\r\n    {% if mhz > 0 %}{% set _ = ws_clock.update({(mhz/1000.0)|round(2): true}) %}{% endif %}\r\n    {% set mem_gb = agent.total_ram or 0 %}\r\n    {% if mem_gb > 0 %}{% set _ = ws_mem.update({(mem_gb*1024)|int: true}) %}{% endif %}\r\n  {% endfor %}\r\n\r\n  <table class=\"workstation-table\">\r\n    <thead>\r\n      <tr class=\"filter-row\">\r\n        <td><span class=\"dot warn\"></span>Attention</td>\r\n        <td><select id=\"ws-warn-os\"><option value=\"\">Any</option>{% for i in ws_os.keys()|sort %}<option value=\"{{i}}\">{{i}}</option>{% endfor %}</select></td>\r\n        <td><select id=\"ws-warn-cores\"><option value=\"\">Any</option>{% for i in ws_cores.keys()|sort|reverse %}<option value=\"{{i}}\">{{i}}</option>{% endfor %}</select></td>\r\n        <td><select id=\"ws-warn-clock\"><option value=\"\">Any</option>{% for i in ws_clock.keys()|sort|reverse %}<option value=\"{{i}}\">{{'%.2f'|format(i)}} Ghz</option>{% endfor %}</select></td>\r\n        <td><select id=\"ws-warn-mem\"><option value=\"\">Any</option>{% for i in ws_mem.keys()|sort|reverse %}<option value=\"{{i}}\">{{(i//1024)|string~' GB' if i>=1024 else i|string~' MB'}}</option>{% endfor %}</select></td>\r\n      </tr>\r\n      <tr class=\"filter-row\">\r\n        <td><span class=\"dot crit\"></span>Critical</td>\r\n        <td><select id=\"ws-crit-os\"><option value=\"\">Any</option>{% for i in ws_os.keys()|sort %}<option value=\"{{i}}\">{{i}}</option>{% endfor %}</select></td>\r\n        <td><select id=\"ws-crit-cores\"><option value=\"\">Any</option>{% for i in ws_cores.keys()|sort|reverse %}<option value=\"{{i}}\">{{i}}</option>{% endfor %}</select></td>\r\n        <td><select id=\"ws-crit-clock\"><option value=\"\">Any</option>{% for i in ws_clock.keys()|sort|reverse %}<option value=\"{{i}}\">{{'%.2f'|format(i)}} Ghz</option>{% endfor %}</select></td>\r\n        <td><select id=\"ws-crit-mem\"><option value=\"\">Any</option>{% for i in ws_mem.keys()|sort|reverse %}<option value=\"{{i}}\">{{(i//1024)|string~' GB' if i>=1024 else i|string~' MB'}}</option>{% endfor %}</select></td>\r\n      </tr>\r\n      <tr>\r\n        <th>Agent Name</th>\r\n        <th>OS</th>\r\n        <th>Cores</th>\r\n        <th>CPU Clock</th>\r\n        <th>Memory</th>\r\n      </tr>\r\n    </thead>\r\n    <tbody>\r\n      {% for agent in workstations %}\r\n        {% set os = agent.operating_system or 'N/A' %}\r\n        {% set cores = (agent.wmi_detail.cpu[0][0].NumberOfCores or 0) if agent.wmi_detail and agent.wmi_detail.cpu else 0 %}\r\n        {% set mhz = (agent.wmi_detail.cpu[0][0].MaxClockSpeed or 0) if agent.wmi_detail and agent.wmi_detail.cpu else 0 %}\r\n        {% set clock = (mhz/1000.0)|round(2) %}\r\n        {% set mem_gb = agent.total_ram or 0 %}\r\n        {% set mem_mb = (mem_gb * 1024)|int %}\r\n        <tr class=\"ws-row\" \r\n            data-os=\"{{os}}\" data-cores=\"{{cores}}\" \r\n            data-clock=\"{{clock}}\" data-mem=\"{{mem_mb}}\">\r\n          <td>{{ agent.hostname }}</td>\r\n          <td class=\"cell-os\">{{ os }}</td>\r\n          <td class=\"cell-cores\">{{ cores if cores > 0 else 'N/A' }}</td>\r\n          <td class=\"cell-clock\">{{ '%.2f Ghz'|format(clock) if clock > 0 else 'N/A' }}</td>\r\n          <td class=\"cell-mem\">{{ mem_gb|string ~ ' GB' if mem_gb > 0 else 'N/A' }}</td>\r\n        </tr>\r\n      {% else %}\r\n        <tr><td colspan=\"5\" style=\"text-align:center;padding:18px;color:#555;\">No Windows workstations found.</td></tr>\r\n      {% endfor %}\r\n    </tbody>\r\n  </table>\r\n</div>\r\n\r\n<div id=\"mac-distribution\" class=\"mac-distribution-section\">\r\n  <h2 class=\"section-header\">Mac Distribution</h2>\r\n  <div class=\"mac-header-bar\">\r\n    <p class=\"description\">\r\n      Use the dropdowns to show agents that fall at or below a specific threshold.\r\n    </p>\r\n    <div id=\"mac-counter\" class=\"counter\"></div>\r\n  </div>\r\n\r\n  {% set mac_agents = [] %}\r\n  {% set mac_os_set = {} %}\r\n  {% set mac_mem_set = {} %}\r\n  {% for agent in data_sources.agentsList if agent.plat == 'darwin' %}\r\n    {% set _ = mac_agents.append(agent) %}\r\n    {% set osname = agent.operating_system or 'macOS' %}\r\n    {% set _ = mac_os_set.update({osname: true}) %}\r\n    \r\n    {% if agent.total_ram %}\r\n      {% set mem_mb = (agent.total_ram * 1024) | int %}\r\n      {% set _ = mac_mem_set.update({mem_mb: true}) %}\r\n    {% endif %}\r\n  {% endfor %}\r\n  {% set mac_os_list = mac_os_set.keys() | list | sort %}\r\n  {% set mac_mem_list = mac_mem_set.keys() | list | sort %}\r\n\r\n  <table class=\"mac-table\" id=\"mac-table-results\">\r\n    <thead>\r\n      <tr class=\"filter-row\">\r\n        <td></td>\r\n        <td>\r\n          <select id=\"mac-filter-os\">\r\n            <option value=\"\">Any</option>\r\n            {% for osname in mac_os_list %}<option value=\"{{ osname }}\">{{ osname }}</option>{% endfor %}\r\n          </select>\r\n        </td>\r\n        <td>\r\n          <select id=\"mac-filter-mem\">\r\n            <option value=\"\">Any</option>\r\n            {% for mb in mac_mem_list %}<option value=\"{{ mb }}\">{{ (mb >= 1024) and (mb//1024)|string ~ ' GB' or mb|string ~ ' MB' }}</option>{% endfor %}\r\n          </select>\r\n        </td>\r\n      </tr>\r\n      <tr>\r\n        <th>Agent Name</th>\r\n        <th>OS</th>\r\n        <th>Memory</th>\r\n      </tr>\r\n    </thead>\r\n    <tbody>\r\n      {% for agent in mac_agents %}\r\n        {% set osname = agent.operating_system or 'macOS' %}\r\n        {% set mem_gb = agent.total_ram %}\r\n        {% set mem_mb = (mem_gb * 1024) if mem_gb else None %}\r\n        <tr class=\"mac-row\"\r\n            data-os=\"{{ osname }}\"\r\n            data-memmb=\"{{ mem_mb if mem_mb is not none else '' }}\">\r\n          <td>{{ agent.hostname }}</td>\r\n          <td>{{ osname }}</td>\r\n          <td>{{ (mem_gb|string ~ ' GB') if mem_gb else 'N/A' }}</td>\r\n        </tr>\r\n      {% else %}\r\n        <tr><td colspan=\"3\" style=\"text-align:center;padding:18px;color:#555;\">No Mac agents found.</td></tr>\r\n      {% endfor %}\r\n      <tr id=\"no-mac-matches-row\" style=\"display: none;\"><td colspan=\"3\" style=\"text-align:center;padding:18px;color:#555;\">No matching Mac agents found.</td></tr>\r\n    </tbody>\r\n  </table>\r\n</div>\r\n\r\n<div id=\"individual-machine-list\">\r\n    <h2 class=\"section-header\">Individual Machine List</h2>\r\n    {% for agent in data_sources.agentsList %}\r\n    <div class=\"section page-break\">\r\n        <div class=\"agent-simple-summary\">\r\n            <div class=\"agent-header\">\r\n                <div class=\"agent-header-title\">\r\n                    {% if agent.plat == 'windows' %}\r\n                        {% if 'server' in agent.operating_system|lower %}\r\n                            <img src=\"https://cdn.jsdelivr.net/npm/@mdi/svg@7.2.96/svg/server.svg\" style=\"width:24px;height:24px;margin-right:8px;\"/>\r\n                        {% else %}\r\n                            <img src=\"https://cdn.jsdelivr.net/npm/@mdi/svg@7.2.96/svg/laptop.svg\" style=\"width:24px;height:24px;margin-right:8px;\"/>\r\n                        {% endif %}\r\n                    {% elif agent.plat == 'linux' %}<img src=\"https://cdn.jsdelivr.net/npm/@mdi/svg@7.2.96/svg/linux.svg\" style=\"width:24px;height:24px;margin-right:8px;\"/>\r\n                    {% elif agent.plat == 'darwin' %}<img src=\"https://cdn.jsdelivr.net/npm/@mdi/svg@7.2.96/svg/apple.svg\" style=\"width:24px;height:24px;margin-right:8px;\"/>\r\n                    {% endif %}\r\n                    {{ agent.hostname or 'N/A' }}\r\n                </div>\r\n                <div class=\"agent-header-details\">\r\n                    <table>\r\n                        <tr><td>Machine Name:</td><td>{{ agent.hostname or 'N/A' }}</td></tr>\r\n                        <tr><td>Workgroup:</td><td>{{ agent.workgroup or 'N/A' }}</td></tr>\r\n                        <tr><td>Last seen:</td><td>{{ agent.last_seen|date(\"Y-m-d H:i:s\") if agent.last_seen else 'N/A' }}</td></tr>\r\n                        <tr><td>Last Logged User:</td><td>{{ agent.last_logged_in_user or 'N/A' }}</td></tr>\r\n                        <tr><td>Last Reboot Time:</td><td>{{ agent.boot_time|date(\"Y-m-d H:i:s\") if agent.boot_time else 'N/A' }}</td></tr>\r\n                        <tr><td>IP Address:</td><td>{{ (agent.public_ip or 'N/A') ~ ' / ' ~ (agent.local_ips | join(', ') if agent.local_ips else 'N/A') }}</td></tr>\r\n                    </table>\r\n                </div>\r\n            </div>\r\n\r\n            <h4>Hardware</h4>\r\n            <table>\r\n                <tr><td class=\"key\">Vendor:</td><td>{{ (agent.wmi_detail.computer[0][0].Manufacturer if agent.wmi_detail and agent.wmi_detail.computer else 'N/A') }}</td></tr>\r\n                <tr><td class=\"key\">Processor:</td><td>{{ agent.cpu_model or 'N/A' }}</td></tr>\r\n                <tr><td class=\"key\">Cores:</td><td>{{ agent.cpu_cores or 'N/A' }}</td></tr>\r\n                <tr><td class=\"key\">BIOS Manufacturer:</td><td>{{ (agent.wmi_detail.bios[0][0].Manufacturer if agent.wmi_detail and agent.wmi_detail.bios else 'N/A') }}</td></tr>\r\n                <tr><td class=\"key\">BIOS Version:</td><td>{{ (agent.wmi_detail.bios[0][0].SMBIOSBIOSVersion if agent.wmi_detail and agent.wmi_detail.bios else 'N/A') }}</td></tr>\r\n                <tr><td class=\"key\">Model:</td><td>{{ (agent.wmi_detail.computer[0][0].Model if agent.wmi_detail and agent.wmi_detail.computer else 'N/A') }}</td></tr>\r\n                <tr><td class=\"key\">Serial Number:</td><td>{{ (agent.wmi_detail.bios[0][0].SerialNumber if agent.wmi_detail and agent.wmi_detail.bios else 'N/A') }}</td></tr>\r\n                <tr><td class=\"key\">Memory:</td><td>{{ agent.total_ram or 'N/A' }} GB</td></tr>\r\n            </table>\r\n\r\n            <h4>Software</h4>\r\n            <table>\r\n                <tr><td class=\"key\">OS Edition:</td><td>{{ agent.operating_system or 'N/A' }}</td></tr>\r\n                <tr><td class=\"key\">OS Build:</td><td>{{ (agent.wmi_detail.os[0][0].BuildNumber if agent.wmi_detail and agent.wmi_detail.os else 'N/A') }}</td></tr>\r\n                <tr><td class=\"key\">System Drive:</td><td>{{ (agent.wmi_detail.os[0][0].SystemDrive if agent.wmi_detail and agent.wmi_detail.os else 'N/A') }}</td></tr>\r\n                <tr><td class=\"key\">Anti-Virus:</td><td>{{ agent.antivirus or 'N/A' }}</td></tr>\r\n            </table>\r\n\r\n            {% set system_drive_letter = (agent.wmi_detail.os[0][0].SystemDrive if agent.wmi_detail and agent.wmi_detail.os else 'C:') %}\r\n            {% for disk in agent.disks %}\r\n                {% if disk.device == system_drive_letter %}\r\n                    <h4>Drive {{ disk.device }}</h4>\r\n                    <table>\r\n                        <tr>\r\n                            <td class=\"key\">BitLocker Protection:</td>\r\n                            <td>\r\n                                {% set bl_info = (agent.wmi_detail.bitlocker | selectattr('DeviceID', 'equalto', disk.device) | list) if agent.wmi_detail and agent.wmi_detail.bitlocker else [] %}\r\n                                {% if bl_info %}{{ 'On' if bl_info[0].ProtectionStatus == 1 else 'Off' }}{% else %}N/A{% endif %}\r\n                            </td>\r\n                        </tr>\r\n                        <tr><td class=\"key\">{{ disk.used }} (Used {{ disk.percent }}%)</td><td>{{ disk.free }} (Free)</td></tr>\r\n                        <tr><td class=\"key\">Total Size:</td><td>{{ disk.total }}</td></tr>\r\n                    </table>\r\n                {% endif %}\r\n            {% endfor %}\r\n        </div>\r\n\r\n        <div class=\"table-container\" style=\"margin-top: 25px;\">\r\n            <div class=\"table-half\">\r\n                <h3>Tasks</h3>\r\n                <table class=\"agent-tasks-table\">\r\n                  <thead><tr><th>Task Name</th><th>Status</th><th>Last Run</th></tr></thead>\r\n                  <tbody>\r\n                    {% for task in data_sources.allFieldsTaskResult if task.agent__hostname == agent.hostname %}\r\n                    <tr>\r\n                      <td>{{ task.task__name or 'N/A' }}</td>\r\n                      <td>\r\n                        {% if task.retcode == 0 %}<span style=\"color: green;\">✓ Passing</span>\r\n                        {% elif task.retcode == 1 %}<span style=\"color: red;\">✗ Failing</span>\r\n                        {% else %}<span style=\"color: gray;\">? Unknown</span>\r\n                        {% endif %}\r\n                      </td>\r\n                      <td>{{ task.last_run.strftime('%Y-%m-%d') if task.last_run else 'N/A' }}</td>\r\n                    </tr>\r\n                    {% else %}\r\n                    <tr><td colspan=\"3\" style=\"text-align:center;\">No tasks found.</td></tr>\r\n                    {% endfor %}\r\n                  </tbody>\r\n                </table>\r\n            </div>\r\n            <div class=\"table-half\">\r\n                <h3>Checks</h3>\r\n                <table class=\"agent-checks-table\">\r\n                  <thead><tr><th>Check Name</th><th>Status</th><th>Last Run</th></tr></thead>\r\n                  <tbody>\r\n                    {% for check in data_sources.checkResults if check.agent__hostname == agent.hostname and check.assigned_check__script__name and check.assigned_check__script__name != 'Unnamed Check' %}\r\n                    <tr>\r\n                      <td>{{ check.assigned_check__script__name }}</td>\r\n                      <td>\r\n                        {% if check.status == 'passing' %}<span style=\"color: green;\">✓ Passing</span>\r\n                        {% else %}<span style=\"color: red;\">✗ Failing</span>\r\n                        {% endif %}\r\n                      </td>\r\n                      <td>{{ check.last_run.strftime('%Y-%m-%d') if check.last_run else 'N/A' }}</td>\r\n                    </tr>\r\n                    {% else %}\r\n                    <tr><td colspan=\"3\" style=\"text-align:center;\">No checks found.</td></tr>\r\n                    {% endfor %}\r\n                  </tbody>\r\n                </table>\r\n            </div>\r\n        </div>\r\n\r\n        <h3>Newly Installed Software (Last 30 Days)</h3>\r\n        <table class=\"agent-sw-table\">\r\n          <thead><tr><th>Software Name</th><th>Version</th><th>Installed Date</th></tr></thead>\r\n          <tbody>\r\n            {% set software_found = [] %}\r\n            {% set cutoff_date = timedelta_30_days.strftime('%Y-%m-%d') %}\r\n            \r\n            {% for software_data in data_sources.softwareList if software_data.agent__hostname == agent.hostname %}\r\n              {% for software in software_data.software %}\r\n                {% if software.install_date and software.install_date != \"01-1-01\" %}\r\n                  \r\n                  {% set date_parts = software.install_date.split('-') %}\r\n                  \r\n                  {% if date_parts|length == 3 %}\r\n                    {% set normalized_date = \"%s-%02d-%02d\" | format(date_parts[0], date_parts[1]|int, date_parts[2]|int) %}\r\n                    \r\n                    {% if normalized_date >= cutoff_date %}\r\n                      {% set _ = software_found.append(software) %}\r\n                    {% endif %}\r\n                  {% else %}\r\n                    {% if software.install_date >= cutoff_date %}\r\n                      {% set _ = software_found.append(software) %}\r\n                    {% endif %}\r\n                  {% endif %}\r\n\r\n                {% endif %}\r\n              {% endfor %}\r\n            {% endfor %}\r\n            \r\n            {% for entry in software_found %}\r\n            <tr>\r\n              <td>{{ entry.name or 'N/A' }}</td>\r\n              <td>{{ entry.version or 'N/A' }}</td>\r\n              <td>{{ entry.install_date }}</td>\r\n            </tr>\r\n            {% else %}\r\n            <tr><td colspan=\"3\" style=\"text-align: center;\">No software installed in the last 30 days.</td></tr>\r\n            {% endfor %}\r\n          </tbody>\r\n        </table>\r\n\r\n        <h3>Patch Management</h3>\r\n        <h4>Installed Patches (Last 30 Days)</h4>\r\n        <table class=\"agent-patch-table\">\r\n          <thead><tr><th>Patch Name</th><th>Severity</th><th>KB Article</th><th>Installed Date</th></tr></thead>\r\n          <tbody>\r\n            {% set installed_patches = [] %}\r\n            {% for patch in data_sources.allFieldsWindowsUpdates if patch.agent__hostname == agent.hostname and patch.installed and patch.date_installed and patch.date_installed.strftime('%Y-%m-%d') >= cutoff_date %}\r\n              {% set _ = installed_patches.append(patch) %}\r\n            {% endfor %}\r\n            {% for patch in installed_patches %}\r\n            <tr>\r\n              <td>{{ patch.title or 'N/A' }}</td>\r\n              <td>{{ patch.severity or 'N/A' }}</td>\r\n              <td>{{ patch.kb_article_ids | join(', ') if patch.kb_article_ids else 'N/A' }}</td>\r\n              <td><span style=\"color: green;\">✓ Installed on {{ patch.date_installed.strftime('%Y-%m-%d') }}</span></td>\r\n            </tr>\r\n            {% else %}\r\n            <tr><td colspan=\"4\" style=\"text-align: center;\">No patches installed in the last 30 days.</td></tr>\r\n            {% endfor %}\r\n          </tbody>\r\n        </table>\r\n\r\n        <h4>Pending Patches (Not Installed Yet)</h4>\r\n        <table class=\"agent-patch-table\">\r\n          <thead><tr><th>Patch Name</th><th>Severity</th><th>KB Article</th><th>Status</th></tr></thead>\r\n          <tbody>\r\n            {% set pending_patches = [] %}\r\n            {% for patch in data_sources.allFieldsWindowsUpdates if patch.agent__hostname == agent.hostname and not patch.installed %}\r\n              {% set _ = pending_patches.append(patch) %}\r\n            {% endfor %}\r\n            {% for patch in pending_patches %}\r\n            <tr>\r\n              <td>{{ patch.title or 'N/A' }}</td>\r\n              <td>{{ patch.severity or 'N/A' }}</td>\r\n              <td>{{ patch.kb_article_ids | join(', ') if patch.kb_article_ids else 'N/A' }}</td>\r\n              <td><span style=\"color: red;\">✗ Not Installed</span></td>\r\n            </tr>\r\n            {% else %}\r\n            <tr><td colspan=\"4\" style=\"text-align: center;\">All patches installed.</td></tr>\r\n            {% endfor %}\r\n          </tbody>\r\n        </table>\r\n    </div>\r\n    {% endfor %}\r\n</div>\r\n\r\n<script>\r\n(function () {\r\n  function valNum(sel) { var v = sel.value; return v ? parseFloat(v) : null; }\r\n  function valInt(sel) { var v = sel.value; return v ? parseInt(v, 10) : null; }\r\n\r\n  // Disk filter script\r\n  function applyDiskFilter() {\r\n    var select = document.getElementById('disk-threshold-select');\r\n    var threshold = parseInt(select.value, 10);\r\n    var rows = document.querySelectorAll('#disk-report-body .disk-row');\r\n    var anyVisible = false;\r\n    rows.forEach(function (row) {\r\n      var freepct = parseInt(row.getAttribute('data-freepct'), 10) || 0;\r\n      if (freepct < threshold) {row.style.display = ''; anyVisible = true;}\r\n      else {row.style.display = 'none';}\r\n    });\r\n    document.getElementById('no-matches-row').style.display = anyVisible ? 'none' : 'block';\r\n  }\r\n\r\n  // Server filter\r\n  function applyServerFilters() {\r\n    const crit = {\r\n      os: document.getElementById('srv-crit-os').value,\r\n      cores: valInt(document.getElementById('srv-crit-cores')),\r\n      clock: valNum(document.getElementById('srv-crit-clock')),\r\n      mem: valInt(document.getElementById('srv-crit-mem')),\r\n    };\r\n    const warn = {\r\n      os: document.getElementById('srv-warn-os').value,\r\n      cores: valInt(document.getElementById('srv-warn-cores')),\r\n      clock: valNum(document.getElementById('srv-warn-clock')),\r\n      mem: valInt(document.getElementById('srv-warn-mem')),\r\n    };\r\n\r\n    document.querySelectorAll('.srv-row').forEach(function(row) {\r\n      const agent = {\r\n        os: row.dataset.os,\r\n        cores: parseInt(row.dataset.cores, 10) || 0,\r\n        clock: parseFloat(row.dataset.clock) || 0.0,\r\n        mem: parseInt(row.dataset.mem, 10) || 0,\r\n      };\r\n\r\n      row.querySelectorAll('td').forEach(td => {\r\n        td.classList.remove('cell-crit', 'cell-warn');\r\n      });\r\n\r\n      const osCell = row.querySelector('.cell-os');\r\n      if (crit.os && agent.os === crit.os) { osCell.classList.add('cell-crit'); } \r\n      else if (warn.os && agent.os === warn.os) { osCell.classList.add('cell-warn'); }\r\n      \r\n      const coresCell = row.querySelector('.cell-cores');\r\n      if (crit.cores && agent.cores <= crit.cores) { coresCell.classList.add('cell-crit'); } \r\n      else if (warn.cores && agent.cores <= warn.cores) { coresCell.classList.add('cell-warn'); }\r\n      \r\n      const clockCell = row.querySelector('.cell-clock');\r\n      if (crit.clock && agent.clock <= crit.clock) { clockCell.classList.add('cell-crit'); } \r\n      else if (warn.clock && agent.clock <= warn.clock) { clockCell.classList.add('cell-warn'); }\r\n      \r\n      const memCell = row.querySelector('.cell-mem');\r\n      if (crit.mem && agent.mem <= crit.mem) { memCell.classList.add('cell-crit'); } \r\n      else if (warn.mem && agent.mem <= warn.mem) { memCell.classList.add('cell-warn'); }\r\n    });\r\n  }\r\n\r\n  // Workstation filter\r\n  function applyWorkstationFilters() {\r\n    const crit = {\r\n      os: document.getElementById('ws-crit-os').value,\r\n      cores: valInt(document.getElementById('ws-crit-cores')),\r\n      clock: valNum(document.getElementById('ws-crit-clock')),\r\n      mem: valInt(document.getElementById('ws-crit-mem')),\r\n    };\r\n    const warn = {\r\n      os: document.getElementById('ws-warn-os').value,\r\n      cores: valInt(document.getElementById('ws-warn-cores')),\r\n      clock: valNum(document.getElementById('ws-warn-clock')),\r\n      mem: valInt(document.getElementById('ws-warn-mem')),\r\n    };\r\n\r\n    document.querySelectorAll('.ws-row').forEach(function(row) {\r\n      const agent = {\r\n        os: row.dataset.os,\r\n        cores: parseInt(row.dataset.cores, 10) || 0,\r\n        clock: parseFloat(row.dataset.clock) || 0.0,\r\n        mem: parseInt(row.dataset.mem, 10) || 0,\r\n      };\r\n\r\n      row.querySelectorAll('td').forEach(td => {\r\n        td.classList.remove('cell-crit', 'cell-warn');\r\n      });\r\n\r\n      const osCell = row.querySelector('.cell-os');\r\n      if (crit.os && agent.os === crit.os) { osCell.classList.add('cell-crit'); } \r\n      else if (warn.os && agent.os === warn.os) { osCell.classList.add('cell-warn'); }\r\n      \r\n      const coresCell = row.querySelector('.cell-cores');\r\n      if (crit.cores && agent.cores <= crit.cores) { coresCell.classList.add('cell-crit'); } \r\n      else if (warn.cores && agent.cores <= warn.cores) { coresCell.classList.add('cell-warn'); }\r\n      \r\n      const clockCell = row.querySelector('.cell-clock');\r\n      if (crit.clock && agent.clock <= crit.clock) { clockCell.classList.add('cell-crit'); } \r\n      else if (warn.clock && agent.clock <= warn.clock) { clockCell.classList.add('cell-warn'); }\r\n      \r\n      const memCell = row.querySelector('.cell-mem');\r\n      if (crit.mem && agent.mem <= crit.mem) { memCell.classList.add('cell-crit'); } \r\n      else if (warn.mem && agent.mem <= warn.mem) { memCell.classList.add('cell-warn'); }\r\n    });\r\n  }\r\n\r\n  // Mac filter script\r\n  function getVersionParts(osString) {\r\n    if (!osString) return [];\r\n    const match = osString.match(/(\\d+(\\.\\d+)*)/);\r\n    if (match && match[0]) {\r\n      return match[0].split('.').map(Number);\r\n    }\r\n    return [];\r\n  }\r\n\r\n  function isVersionLessOrEqual(agentVersion, maxVersion) {\r\n    const len = Math.max(agentVersion.length, maxVersion.length);\r\n    for (let i = 0; i < len; i++) {\r\n      const agentPart = agentVersion[i] || 0;\r\n      const maxPart = maxVersion[i] || 0;\r\n      if (agentPart < maxPart) return true;\r\n      if (agentPart > maxPart) return false;\r\n    }\r\n    return true; // versions are equal\r\n  }\r\n\r\n  function applyMacFilters() {\r\n    var filters = {\r\n      os: document.getElementById('mac-filter-os').value,\r\n      mem: valInt(document.getElementById('mac-filter-mem'))\r\n    };\r\n    \r\n    var maxVersionParts = getVersionParts(filters.os);\r\n    var rows = document.querySelectorAll('#mac-table-results .mac-row');\r\n    var matchedCount = 0;\r\n    \r\n    rows.forEach(function (row) {\r\n      var agent = {\r\n        os: row.getAttribute('data-os') || '',\r\n        mem: parseInt(row.getAttribute('data-memmb') || '0', 10)\r\n      };\r\n      var agentVersionParts = getVersionParts(agent.os);\r\n\r\n      var isMatch = true;\r\n      if (filters.os && !isVersionLessOrEqual(agentVersionParts, maxVersionParts)) isMatch = false;\r\n      if (filters.mem !== null && agent.mem > filters.mem) isMatch = false;\r\n\r\n      if(isMatch) {\r\n        row.style.display = '';\r\n        matchedCount++;\r\n      } else {\r\n        row.style.display = 'none';\r\n      }\r\n    });\r\n\r\n    document.getElementById('mac-counter').textContent = 'Matched: ' + matchedCount + ' / ' + rows.length;\r\n    \r\n    var noMatchesRow = document.getElementById('no-mac-matches-row');\r\n    if (matchedCount === 0 && rows.length > 0) {\r\n        noMatchesRow.style.display = '';\r\n    } else {\r\n        noMatchesRow.style.display = 'none';\r\n    }\r\n  }\r\n\r\n  // Navigation smooth scroll script\r\n  function setupNav() {\r\n      var navLinks = document.querySelectorAll('.navbar a');\r\n      navLinks.forEach(function(link) {\r\n          link.addEventListener('click', function(e) {\r\n              e.preventDefault();\r\n              var targetId = this.getAttribute('data-target');\r\n              var targetElement = document.getElementById(targetId);\r\n              if (targetElement) {\r\n                  targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });\r\n              }\r\n          });\r\n      });\r\n  }\r\n  \r\n  // DOMContentLoaded to run all scripts\r\n  document.addEventListener('DOMContentLoaded', function () {\r\n    var diskSelect = document.getElementById('disk-threshold-select');\r\n    if (diskSelect) {diskSelect.addEventListener('change', applyDiskFilter); applyDiskFilter();}\r\n    \r\n    ['mac-filter-os','mac-filter-mem']\r\n      .forEach(function(id){ \r\n          var el = document.getElementById(id); \r\n          if (el) el.addEventListener('change', applyMacFilters); \r\n      });\r\n    applyMacFilters();\r\n\r\n    ['ws-crit-os', 'ws-crit-cores', 'ws-crit-clock', 'ws-crit-mem',\r\n     'ws-warn-os', 'ws-warn-cores', 'ws-warn-clock', 'ws-warn-mem']\r\n     .forEach(id => {\r\n        const el = document.getElementById(id);\r\n        if (el) el.addEventListener('change', applyWorkstationFilters);\r\n     });\r\n    applyWorkstationFilters();\r\n\r\n    // **FIXED**: Added event listeners for server filters\r\n    ['srv-crit-os', 'srv-crit-cores', 'srv-crit-clock', 'srv-crit-mem',\r\n     'srv-warn-os', 'srv-warn-cores', 'srv-warn-clock', 'srv-warn-mem']\r\n     .forEach(id => {\r\n        const el = document.getElementById(id);\r\n        if (el) el.addEventListener('change', applyServerFilters);\r\n     });\r\n    applyServerFilters();\r\n\r\n    setupNav();\r\n  });\r\n})();\r\n</script>\r\n\r\n{% endblock %}",
    "type": "html",
    "depends_on": [
      "client"
    ],
    "template_variables": "report_run_timestamp: !now\ntimedelta_30_days: !now days=-30\n\ndata_sources:\n  agentsList:\n    filter:\n      site__client_id: \"{{client.id}}\"\n    model: agent\n    only:\n      - hostname\n      - operating_system\n      - site__name\n      - site__client__name\n      - last_logged_in_user\n      - wmi_detail\n      - total_ram\n      - needs_reboot\n      - disks\n      - plat\n  allFieldsTaskResult:\n    model: taskresult\n    filter:\n      agent__site__client__id: \"{{ client.id }}\"\n    order_by:\n      - agent__site__client__name\n      - agent__site__name\n      - agent__hostname\n      - task__name\n    only:\n      - id\n      - agent__site__client__name\n      - agent__site__name\n      - task__name\n      - agent__hostname\n      - retcode\n      - last_run\n  checkResults:\n    model: checkresult\n    select_related:\n      - agent__site\n      - agent__site__client\n    only:\n      - agent__hostname\n      - assigned_check__script__name\n      - status\n      - last_run\n  softwareList:\n    model: installedsoftware\n    filter:\n      agent__site__client__id: \"{{ client.id }}\"\n    only:\n      - agent__hostname\n      - software\n  allFieldsWindowsUpdates:\n    filter:\n      agent__site__client__id: \"{{client.id}}\"\n    model: winupdate\n    only:\n      - id\n      - agent__hostname\n      - title\n      - installed\n      - description\n      - severity\n      - categories\n      - category_ids\n      - kb_article_ids\n      - date_installed"
  },
  "assets": []
}